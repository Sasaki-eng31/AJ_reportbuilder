<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>メーカー別売上レポート ビルダー - 改良版</title>
    <style>
        /* --- 全体のスタイル --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Hiragino Sans', 'Yu Gothic UI', sans-serif;
            background: #f0f2f5; /* 背景をシンプルに */
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: #dc3912; /* テーマカラーに変更 */
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .header p { font-size: 1.2em; opacity: 0.9; }
        
        .main-content { 
            display: flex; 
            min-height: calc(100vh - 120px);
            align-items: flex-start;
            max-height: calc(100vh - 120px);
            overflow: hidden;
        }
        
        /* --- サイドバー --- */
        .sidebar {
            width: 320px;
            background: #f8f9fa;
            border-right: 2px solid #efefef; /* テーマカラーに変更 */
            padding: 20px;
            overflow-y: auto;
            height: calc(100vh - 120px);
            position: sticky;
            top: 0;
            flex-shrink: 0;
        }
        
        .sidebar h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #dc3912; /* テーマカラーに変更 */
        }
        
        .data-upload-section {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #efefef; /* テーマカラーに変更 */
        }
        
        .upload-item { margin-bottom: 15px; }
        
        .upload-item label {
            display: block;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        
        .upload-item input[type="file"] {
            width: 100%; padding: 8px; border: 2px dashed #bdc3c7; border-radius: 5px;
            background: #fafafa; transition: all 0.3s ease;
        }
        
        .upload-item input[type="file"]:hover { border-color: #dc3912; background: #fff8f5; }
        
        .upload-status { font-size: 0.8em; margin-top: 5px; padding: 5px; border-radius: 3px; }
        .upload-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        
        .component-library { display: flex; flex-direction: column; gap: 10px; }
        
        .component-item {
            background: white; padding: 15px; border-radius: 8px; border: 2px solid #efefef;
            cursor: grab; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .component-item:hover {
            transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15);
            border-color: #dc3912; /* テーマカラーに変更 */
        }
        
        .component-item h4 { color: #2c3e50; margin-bottom: 5px; font-size: 0.9em; }
        .component-item p { color: #6c757d; font-size: 0.8em; line-height: 1.4; }
        
        /* --- キャンバス（編集エリア） --- */
        .canvas {
            flex: 1; padding: 20px; background: #fff;
            overflow-y: auto; height: calc(100vh - 120px);
        }
        
        .canvas-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 30px; padding-bottom: 15px; border-bottom: 2px solid #e9ecef;
        }
        
        .canvas-title { font-size: 1.5em; color: #2c3e50; }
        .canvas-actions { display: flex; gap: 10px; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 25px; cursor: pointer; font-weight: bold; transition: all 0.3s ease; font-size: 0.9em; }
        .btn-primary { background: #dc3912; color: white; } /* テーマカラーに変更 */
        .btn-primary:hover { background: #c53210; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(220, 57, 18, 0.3); }
        .btn-secondary { background: #95a5a6; color: white; }
        .btn-secondary:hover { background: #7f8c8d; transform: translateY(-2px); }
        
        .drop-zone { min-height: 500px; border: 3px dashed #bdc3c7; border-radius: 10px; padding: 20px; background: #fafafa; transition: all 0.3s ease; }
        .drop-zone.drag-over { border-color: #dc3912; background: #fff8f5; } /* テーマカラーに変更 */
        .drop-zone-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #95a5a6; text-align: center; }
        .drop-zone-placeholder i { font-size: 4em; margin-bottom: 20px; opacity: 0.3; }
        
        /* --- レポートコンポーネントのスタイル --- */
        .report-component {
            background: white; margin-bottom: 20px; border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); overflow: hidden;
            border: 2px solid transparent; transition: all 0.3s ease;
        }
        
        .report-component:hover {
            border-color: #dc3912; /* テーマカラーに変更 */
            transform: translateY(-2px); box-shadow: 0 8px 16px rgba(0,0,0,0.15);
        }
        
        .component-header {
            background: #34495e; /* メインヘッダーと区別 */
            color: white; padding: 15px 20px; display: flex;
            justify-content: space-between; align-items: center;
        }
        
        .component-header h4 { margin: 0; font-size: 1.1em; }
        .component-controls { display: flex; gap: 8px; }
        
        .control-btn {
            background: rgba(255,255,255,0.2); border: none; color: white; width: 30px; height: 30px;
            border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;
        }
        .control-btn:hover { background: rgba(255,255,255,0.3); transform: scale(1.1); }
        .component-content { padding: 20px; }
        
        /* --- フォーム要素 --- */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: #2c3e50; font-weight: bold; }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 5px;
            font-family: inherit; transition: border-color 0.3s ease;
        }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: #dc3912; } /* テーマカラーに変更 */
        
        .review-item {
            padding: 15px;
            border: 1px solid #efefef;
            border-radius: 5px;
            margin-bottom: 10px;
            background: #fafafa;
        }

        .add-product-area {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background-color: #f8f9fa;
        }
        .add-product-area label {
             font-size: 0.9em;
             margin-bottom: 8px;
        }

        /* --- チャートとテーブル --- */
        .chart-container { background: #f8f9fa; border-radius: 8px; padding: 20px; text-align: center; min-height: 200px; display: flex; align-items: center; justify-content: center; color: #6c757d; }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .data-table th, .data-table td { padding: 12px; text-align: left; border-bottom: 1px solid #e9ecef; }
        .data-table th { background: #f8f9fa; font-weight: bold; color: #2c3e50; }
        .data-table tr:hover { background: #f8f9fa; }
        
        .editable-cell {
            border: none;
            background-color: transparent;
            width: 100%;
            padding: 0;
            margin: 0;
            font-size: inherit;
            font-family: inherit;
        }
        .editable-cell:focus {
            outline: 1px solid #dc3912;
            background-color: #fff8f5;
        }

        .delete-row-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 18px;
            padding: 0 5px;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        .delete-row-btn:hover { opacity: 1; color: #e74c3c; }


        /* --- トースト通知 --- */
        .toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: #27ae60; color: white; padding: 15px 25px; border-radius: 25px;
            box-shadow: 0 6px 12px rgba(0,0,0,0.15); z-index: 1001; display: none;
        }
        
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>メーカー別売上レポート ビルダー</h1>
            <p>CSV直接入力対応｜ドラッグ&ドロップで自由にレポートをカスタマイズ</p>
        </div>
        
        <div class="main-content">
            <div class="sidebar">
                <div class="data-upload-section">
                    <h3>📁 データアップロード</h3>
                    <div class="upload-item"><label>【必須】商品マスタ (スマレジCSV)</label><input type="file" accept=".csv" id="productMasterUpload"><div id="status-productMaster" class="upload-status" style="display: none;"></div></div>
                    <div class="upload-item"><label>【必須】商品別売上データ (CSV)</label><input type="file" accept=".csv" id="productSalesUpload"><div id="status-productSales" class="upload-status" style="display: none;"></div></div>
                    <div class="upload-item"><label>【任意】取引データ (CSV)</label><input type="file" accept=".csv" id="transactionUpload"><div id="status-transaction" class="upload-status" style="display: none;"></div></div>
                    <div class="upload-item"><label>【任意】客層別売上 - 年代 (CSV)</label><input type="file" accept=".csv" id="ageUpload"><div id="status-age" class="upload-status" style="display: none;"></div></div>
                    <div class="upload-item"><label>【任意】客層別売上 - 性別 (CSV)</label><input type="file" accept=".csv" id="genderUpload"><div id="status-gender" class="upload-status" style="display: none;"></div></div>
                    <div class="upload-item"><label>【任意】客層別売上 - 来店回数 (CSV)</label><input type="file" accept=".csv" id="visitFrequencyUpload"><div id="status-visitFrequency" class="upload-status" style="display: none;"></div></div>
                    <div class="upload-item"><label>【任意】客層別売上 - 来店目的 (CSV)</label><input type="file" accept=".csv" id="visitPurposeUpload"><div id="status-visitPurpose" class="upload-status" style="display: none;"></div></div>
                </div>
                
                <h3>📦 コンポーネント</h3>
                <div class="component-library">
                    <div class="component-item" draggable="true" data-type="header"><h4>◆ ヘッダー情報</h4><p>会社名・期間・タイトルなど</p></div>
                     <div class="component-item" draggable="true" data-type="sales-summary"><h4>◆ 売上サマリー (イベント全体)</h4><p>総売上・客数・平均単価</p></div>
                     <div class="component-item" draggable="true" data-type="event-review"><h4>◆ MD全体の振り返り</h4><p>番号なしの見出しとコメント</p></div>
                    <div class="component-item" draggable="true" data-type="product-table"><h4>◆ 商品別売上表</h4><p>商品名・販売数・売上一覧</p></div>
                    <div class="component-item" draggable="true" data-type="demographics-chart"><h4>◆ 客層分析チャート</h4><p>年代・性別・来店回数など</p></div>
                    <div class="component-item" draggable="true" data-type="image"><h4>◆ 写真・画像</h4><p>商品写真・イベント写真など</p></div>
                    <div class="component-item" draggable="true" data-type="customer-voice"><h4>◆ お客様の声</h4><p>フィードバック・コメント</p></div>
                    <div class="component-item" draggable="true" data-type="staff-comments"><h4>◆ スタッフ所感</h4><p>改善提案・気づき</p></div>
                    <div class="component-item" draggable="true" data-type="text-block"><h4>◆ 自由テキスト</h4><p>カスタムコンテンツ</p></div>
                </div>
            </div>
            
            <div class="canvas">
                <div class="canvas-header">
                    <div class="canvas-title">レポート編集エリア</div>
                    <div class="canvas-actions">
                        <button class="btn btn-secondary" onclick="clearCanvas()">🗑️ クリア</button>
                        <button class="btn btn-primary" onclick="previewReport()">👁️ プレビュー</button>
                        <button class="btn btn-primary" onclick="printReport()" style="background: #e74c3c;">🖨️ PDF印刷</button>
                    </div>
                </div>
                
                <div class="drop-zone" id="dropZone">
                    <div class="drop-zone-placeholder"><i>📦</i><h3>コンポーネントをここにドラッグ&ドロップ</h3><p>左のサイドバーからお好みのコンポーネントを追加してレポートを作成できます</p></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>

    <script>
        // グローバル変数
        var csvData = {};
        var productMasterData = new Map(); // 商品マスタ（単価情報）を保持
        var componentCounter = 0;
        var draggedElement = null;
        window.imageData = {};
        window.textImageData = {};

        // ファイルアップロード処理のセットアップ
        function setupFileUploads() {
            var fileInputs = [
                {id: 'productMasterUpload', type: 'productMaster'},
                {id: 'productSalesUpload', type: 'productSales'},
                {id: 'transactionUpload', type: 'transaction'},
                {id: 'ageUpload', type: 'age'},
                {id: 'genderUpload', type: 'gender'},
                {id: 'visitFrequencyUpload', type: 'visitFrequency'},
                {id: 'visitPurposeUpload', type: 'visitPurpose'}
            ];
            
            fileInputs.forEach(function(item) {
                var input = document.getElementById(item.id);
                if (input) {
                    input.addEventListener('change', function(e) { handleFileUpload(e.target, item.type); });
                }
            });
        }
        
        // ファイルアップロードハンドラ
        function handleFileUpload(input, dataType) {
            if (!input.files || !input.files[0]) return;
            var file = input.files[0];
            var statusDiv = document.getElementById('status-' + dataType);
            statusDiv.innerHTML = '⏳ 読み込み中...';
            statusDiv.className = 'upload-status';
            statusDiv.style.display = 'block';
            
            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = e.target.result.split(/\r?\n/).map(line => line.split(',').map(cell => cell.trim().replace(/^"|"$/g, ''))).filter(row => row.length > 1 && row.some(cell => cell));
                    if (data.length === 0) throw new Error('データが空です');
                    
                    const headers = data[0];
                    if (dataType === 'productMaster') {
                        productMasterData.clear();
                        const findIndex = (possibleNames) => {
                            for (const name of possibleNames) {
                                const index = headers.indexOf(name);
                                if (index !== -1) return index;
                            }
                            return -1;
                        };
                        const idx = {
                            code: findIndex(['商品コード', '品番']),
                            name: findIndex(['商品名']),
                            price: findIndex(['販売価格', '単価', '商品単価']),
                            group: findIndex(['グループコード', 'グループ', 'メーカー', '社名'])
                        };

                        if ([idx.code, idx.name, idx.price, idx.group].some(i => i === -1)) {
                             const missing = [];
                             if (idx.code === -1) missing.push("商品コード");
                             if (idx.name === -1) missing.push("商品名");
                             if (idx.price === -1) missing.push("販売価格/商品単価");
                             if (idx.group === -1) missing.push("グループコード/グループ");
                            throw new Error(`商品マスタCSVに必須の列（${missing.join(', ')}）が見つかりません。`);
                        }

                        data.slice(1).forEach(row => {
                            const productCode = row[idx.code];
                            const unitPrice = parseFloat(row[idx.price]);
                            if (productCode && !isNaN(unitPrice)) {
                                productMasterData.set(productCode, {
                                    name: row[idx.name],
                                    price: unitPrice,
                                    group: row[idx.group] || '',
                                    dept: '' 
                                });
                            }
                        });
                        statusDiv.innerHTML = `✅ ${file.name} (${productMasterData.size}件) 読み込み完了`;
                        showToast(`商品マスタを読み込みました (${productMasterData.size}件)`);

                    } else {
                        csvData[dataType] = data;
                        statusDiv.innerHTML = `✅ ${file.name} (${data.length - 1}行) 読み込み完了`;
                        showToast(`${file.name} を読み込みました`);
                    }
                    
                    setTimeout(() => updateRelatedComponents(dataType), 100);

                } catch (error) {
                    statusDiv.innerHTML = `❌ エラー: ${error.message}`;
                    showToast(error.message, 'error');
                }
            };
            reader.onerror = () => { statusDiv.innerHTML = '❌ ファイル読み込みエラー'; showToast('ファイル読み込みエラー', 'error'); };
            reader.readAsText(file, 'Shift_JIS'); 
        }
        
        // データ更新時に関連コンポーネントを更新
        function updateRelatedComponents(dataType) {
            if (['age', 'gender', 'visitFrequency', 'visitPurpose'].includes(dataType)) {
                document.querySelectorAll('.report-component[data-type="demographics-chart"]').forEach(component => {
                    const componentId = component.dataset.id;
                    const chartTypeSelect = document.getElementById('chartType_' + componentId);
                    if (chartTypeSelect && chartTypeSelect.value === dataType) { updateChart(componentId); }
                });
            } else if (dataType === 'productSales' || dataType === 'productMaster') {
                populateMakerOptions();
            }
        }
        
        function initDragDrop() {
            document.querySelectorAll('.component-item').forEach(item => {
                item.addEventListener('dragstart', e => { draggedElement = e.target; });
            });
            const dropZone = document.getElementById('dropZone');
            dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
            dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
            dropZone.addEventListener('drop', e => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
                if (draggedElement) { addComponent(draggedElement.dataset.type); }
            });
        }
        
        // コンポーネント追加
        function addComponent(type) {
            componentCounter++;
            const dropZone = document.getElementById('dropZone');
            const placeholder = dropZone.querySelector('.drop-zone-placeholder');
            if (placeholder) placeholder.remove();
            
            const component = createComponent(type, componentCounter);
            dropZone.appendChild(component);
            showToast(getComponentName(type) + ' を追加しました');

            if (type === 'text-block') { updateTextBlockDisplay(componentCounter); }
            if (type === 'product-table' && csvData.productSales) { setTimeout(populateMakerOptions, 200); }
        }
        
        // コンポーネントのDOMを生成
        function createComponent(type, id) {
            const div = document.createElement('div');
            div.className = 'report-component';
            div.dataset.type = type;
            div.dataset.id = id;
            div.innerHTML = `
                <div class="component-header"><h4>${getComponentName(type)}</h4>
                    <div class="component-controls">
                        <button class="control-btn" onclick="moveUp(this)">↑</button>
                        <button class="control-btn" onclick="moveDown(this)">↓</button>
                        <button class="control-btn" onclick="deleteComponent(this)">🗑️</button>
                    </div>
                </div>
                <div class="component-content">${getComponentContent(type, id)}</div>`;
            return div;
        }

        // コンポーネント名取得
        function getComponentName(type) {
            const names = {
                'header': '◆ ヘッダー情報', 'sales-summary': '◆ 売上サマリー (イベント全体)', 'product-table': '◆ 商品別売上表',
                'demographics-chart': '◆ 客層分析チャート', 'image': '◆ 写真・画像', 'customer-voice': '◆ お客様の声',
                'staff-comments': '◆ スタッフ所感', 'text-block': '◆ 自由テキスト', 'event-review': '◆ MD全体の振り返り'
            };
            return names[type] || '❓ 不明なコンポーネント';
        }
        
        // コンポーネントのコンテンツHTMLを生成
        function getComponentContent(type, id) {
             switch(type) {
                case 'header':
                    return `<div style="display: flex; gap: 15px; align-items: flex-end;">
                               <div class="form-group" style="flex: 1;">
                                   <label>会社名</label>
                                   <input type="text" value="株式会社こしき" id="company_${id}">
                               </div>
                               <div class="form-group" style="flex-basis: 100px;">
                                   <label>敬称</label>
                                   <select id="honorific_${id}">
                                       <option value="様">様</option>
                                       <option value="御中" selected>御中</option>
                                   </select>
                               </div>
                           </div>
                           <div class="form-group"><label>イベント名</label><input type="text" value="アナザー・宮城" id="event_${id}"></div>
                           <div class="form-group"><label>実施期間</label><input type="text" value="2025年4月29日(火)〜5月18日(日) 【20日間】" id="period_${id}"></div>`;
                case 'sales-summary':
                    return `<p style="font-size:0.9em; color:#666; margin-bottom:15px;">取引データCSVをアップロードすると、イベント全体の売上などが自動で計算されます。</p>
                            <div class="form-group"><label>純売上(税抜)</label><input type="text" id="sales_${id}" readonly style="background:#eee;"></div>
                           <div class="form-group"><label>購入客数</label><input type="text" id="customers_${id}" readonly style="background:#eee;"></div>
                           <div class="form-group"><label>平均購入単価</label><input type="text" id="avgprice_${id}" readonly style="background:#eee;"></div>
                           <button class="btn btn-secondary" onclick="loadSalesData(${id})" style="margin-top: 10px;">取引データから計算</button>`;
                case 'event-review':
                    return `<div id="review-items-container-${id}"></div>
                            <button class="btn btn-secondary" onclick="addReviewItem(${id})" style="margin-top: 10px;">＋ 項目を追加</button>`;
                case 'product-table':
                    return `<div class="form-group"><label>対象メーカー選択</label><select id="makerSelect_${id}" onchange="updateProductTable(${id})"><option value="">メーカーを選択してください</option></select></div>
                           <div id="table_${id}"><div style="padding: 20px; text-align: center; color: #666; border: 2px dashed #ddd; border-radius: 8px;"><h4>◆ 商品別売上表</h4><p>商品マスタと商品別売上データをアップロードし、メーカーを選択してください</p></div></div>
                           <div class="add-product-area" id="addProductArea_${id}" style="display:none;">
                                <label>レジミスなどで計上されなかった商品を手動で追加</label>
                                <div style="display:flex; gap:10px;">
                                    <select id="addProductSelect_${id}" style="flex:1;"></select>
                                    <button class="btn btn-secondary" onclick="addProductFromMaster(${id})">商品を追加</button>
                                </div>
                           </div>`;
                case 'demographics-chart':
                    return `<div class="form-group"><label>分析種別</label><select id="chartType_${id}" onchange="updateChart(${id})"><option value="age">年代別</option><option value="gender">性別</option><option value="visitFrequency">来店回数</option><option value="visitPurpose">来店目的</option></select></div><div class="chart-container" id="chart_${id}">${generateChart('age')}</div><div class="form-group"><label>分析コメント</label><textarea rows="4" id="comment_${id}" placeholder="客層分析コメント..."></textarea></div>`;
                case 'image':
                    return `<div class="form-group"><label>画像タイトル</label><input type="text" value="商品写真" id="imageTitle_${id}"></div><div class="form-group"><label>レイアウト</label><select id="imageLayout_${id}" onchange="updateImageLayout(${id})"><option value="single" selected>1枚表示</option><option value="two">2枚横並び</option><option value="three">3枚横並び</option></select></div><div id="imageUploadArea_${id}">${createImageUploadInputs(id, 1)}</div><div id="imagePreview_${id}" style="margin-top: 15px; border: 2px dashed #ddd; padding: 20px; border-radius: 8px; color: #666; text-align: center;"><p>画像をアップロードしてください</p></div>`;
                case 'customer-voice':
                    return `<div class="form-group"><label>お客様の声</label><textarea rows="6" id="voice_${id}" placeholder="お客様からのフィードバック..." style="white-space: pre-wrap;"></textarea></div>`;
                case 'staff-comments':
                    return `<div class="form-group"><label>スタッフからの所感・提案</label><textarea rows="6" id="staff_${id}" placeholder="販売活動での気づきや改善提案..." style="white-space: pre-wrap;"></textarea></div>`;
                case 'text-block':
                    return `<div class="form-group"><label>タイトル</label><input type="text" value="カスタムセクション" id="title_${id}" oninput="updateTextBlockDisplay(${id})"></div><div class="form-group"><label>レイアウト</label><select id="textLayout_${id}" onchange="updateTextLayout(${id})"><option value="text-only" selected>テキストのみ</option><option value="text-image-right">テキスト(左)＋画像(右)</option><option value="text-image-left">画像(左)＋テキスト(右)</option></select></div><div class="form-group"><label>内容</label><textarea rows="6" id="content_${id}" placeholder="自由にテキストを入力..." oninput="updateTextBlockDisplay(${id})"></textarea></div><div id="textImageOptions_${id}" style="display:none; border-top: 1px solid #eee; padding-top: 15px;"><div class="form-group"><label>画像ファイル</label><input type="file" accept="image/*" id="textImageFile_${id}" onchange="handleTextBlockImageUpload(${id})"></div><div class="form-group"><label>画像サイズ</label><select id="textImageSize_${id}" onchange="updateTextBlockDisplay(${id})"><option value="30%">小 (30%)</option><option value="40%" selected>中 (40%)</option><option value="50%">大 (50%)</option></select></div></div><div style="margin-top: 15px; font-weight: bold;">プレビュー:</div><div id="textPreview_${id}" style="border: 2px dashed #ddd; padding: 20px; border-radius: 8px; min-height: 100px; line-height: 1.6;"></div>`;
                default:
                    return '<p>不明なコンポーネントです。</p>';
            }
        }

        function addReviewItem(componentId) {
            const container = document.getElementById(`review-items-container-${componentId}`);
            const newItem = document.createElement('div');
            newItem.className = 'review-item';
            newItem.innerHTML = `<div class="form-group"><label>見出し</label><input type="text" class="review-item-title" placeholder="振り返りの見出し..."></div><div class="form-group"><label>内容</label><textarea class="review-item-content" rows="4" placeholder="具体的な内容..."></textarea></div><button class="btn btn-secondary" style="background: #e74c3c; font-size: 0.8em; padding: 5px 10px;" onclick="this.parentElement.remove()">この項目を削除</button>`;
            container.appendChild(newItem);
        }

        // メーカー選択肢を生成
        function populateMakerOptions() {
            if (productMasterData.size === 0) return;
            const makers = new Set();
            productMasterData.forEach(prod => {
                if (prod.group) makers.add(prod.group);
            });

            document.querySelectorAll('select[id^="makerSelect_"]').forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">メーカーを選択してください</option>';
                Array.from(makers).sort().forEach(maker => {
                    select.add(new Option(maker, maker, false, maker === currentValue));
                });
            });
            if (makers.size > 0) showToast(`${makers.size}個のメーカー/ブランドを検出しました`);
        }
        
        // 商品売上表の更新
        function updateProductTable(componentId) {
            const select = document.getElementById('makerSelect_' + componentId);
            const tableDiv = document.getElementById('table_' + componentId);
            const addProductDiv = document.getElementById('addProductArea_' + componentId);
            const selectedMaker = select?.value;

            if (!csvData.productSales) { tableDiv.innerHTML = `<p class="message error">商品別売上データをアップロードしてください</p>`; addProductDiv.style.display = 'none'; return; }
            if (productMasterData.size === 0) { tableDiv.innerHTML = `<p class="message error">商品マスタデータをアップロードしてください</p>`; addProductDiv.style.display = 'none'; return; }
            if (!selectedMaker) { tableDiv.innerHTML = `<div style="padding: 20px; text-align: center; color: #666; border: 2px dashed #ddd; border-radius: 8px;"><h4>◆ 商品別売上表</h4><p>上のプルダウンからメーカーを選択してください</p></div>`; addProductDiv.style.display = 'none'; return; }
            
            try {
                const data = csvData.productSales;
                const headers = data[0];
                const idx = { code: headers.indexOf('商品コード'), name: headers.indexOf('商品名'), maker: headers.indexOf('グループコード'), dept: headers.indexOf('部門名'), sales: headers.indexOf('純売上'), netSales: headers.indexOf('純売上(税抜)'), ratio: headers.indexOf('純売上構成比'), qty: headers.indexOf('販売点数') };
                if ([idx.code, idx.maker, idx.qty, idx.netSales].includes(-1)) { throw new Error('商品別売上CSVの列名（商品コード, グループコード, 販売点数, 純売上(税抜)）が正しくありません。'); }

                const filteredRows = data.slice(1).filter(row => row[idx.maker]?.trim() === selectedMaker && (parseInt(row[idx.qty], 10) || 0) > 0);
                
                const displayHeaders = ['商品名', 'グループコード', '部門名', '純売上', '純売上(税抜)', '純売上構成比', '販売点数'];
                let tableHTML = '<table class="data-table"><thead><tr>';
                displayHeaders.forEach(h => { tableHTML += `<th>${h}</th>`; });
                tableHTML += `<th>商品を削除</th></tr></thead><tbody>`;
                
                filteredRows.forEach((row) => {
                    tableHTML += createTableRow(row[idx.code], row, idx, componentId);
                });
                
                tableHTML += `<tr class="totals-row" style="background:#efefef;font-weight:bold;"><td colspan="3">【合計】</td><td data-total="sales"></td><td data-total="netSales"></td><td>-</td><td data-total="qty"></td><td></td></tr>`;
                tableHTML += '</tbody></table>';
                tableDiv.innerHTML = tableHTML;

                addProductDiv.style.display = 'block';
                populateAddProductDropdown(componentId, selectedMaker);
                recalculateAllSalesData(componentId);

            } catch (e) { tableDiv.innerHTML = `<p class="message error">エラー: ${e.message}</p>`; showToast(e.message, 'error'); }
        }

        // 商品追加ドロップダウンを生成
        function populateAddProductDropdown(componentId, selectedMaker) {
            const select = document.getElementById(`addProductSelect_${componentId}`);
            select.innerHTML = '<option value="">追加する商品を選択...</option>';
            for (const [code, product] of productMasterData.entries()) {
                if (product.group === selectedMaker) {
                    select.add(new Option(product.name, code));
                }
            }
        }
        
        // 商品マスタから商品を表に追加
        function addProductFromMaster(componentId) {
            const select = document.getElementById(`addProductSelect_${componentId}`);
            const productCode = select.value;
            if (!productCode) return;

            const table = document.getElementById(`table_${componentId}`).querySelector('tbody');
            // 既に追加されているかチェック
            if (table.querySelector(`tr[data-product-code="${productCode}"]`)) {
                showToast('この商品は既に追加されています。数量を編集してください。', 'error');
                return;
            }

            const product = productMasterData.get(productCode);
            const netSales = product.price * 1;
            const sales = Math.floor(netSales * 1.1); // 仮税率10%

            const headers = csvData.productSales[0];
            const idx = { code: headers.indexOf('商品コード'), name: headers.indexOf('商品名'), maker: headers.indexOf('グループコード'), dept: headers.indexOf('部門名'), sales: headers.indexOf('純売上'), netSales: headers.indexOf('純売上(税抜)'), ratio: headers.indexOf('純売上構成比'), qty: headers.indexOf('販売点数') };

            const mockRow = [];
            mockRow[idx.code] = productCode;
            mockRow[idx.name] = product.name;
            mockRow[idx.maker] = product.group;
            mockRow[idx.dept] = product.dept;
            mockRow[idx.sales] = sales;
            mockRow[idx.netSales] = netSales;
            mockRow[idx.qty] = 1;


            const newRowHTML = createTableRow(productCode, mockRow, idx, componentId);
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = newRowHTML;
            table.insertBefore(tempDiv.firstChild, table.querySelector('.totals-row'));
            
            recalculateAllSalesData(componentId);
            select.value = ''; // プルダウンをリセット
        }

        // 共通のテーブル行生成ロジック
        function createTableRow(productCode, rowData, idx, componentId) {
            let rowHTML = `<tr data-product-code="${productCode}">`;
            rowHTML += `<td>${rowData[idx.name] || ''}</td>`;
            rowHTML += `<td>${rowData[idx.maker] || ''}</td>`;
            rowHTML += `<td>${rowData[idx.dept] || ''}</td>`;
            rowHTML += `<td><input type="text" class="editable-cell" value="${rowData[idx.sales] || ''}" readonly></td>`;
            rowHTML += `<td><input type="text" class="editable-cell" value="${rowData[idx.netSales] || ''}" readonly></td>`;
            rowHTML += `<td data-role="ratio">${rowData[idx.ratio] || '0.00'}</td>`;
            rowHTML += `<td><input type="text" class="editable-cell" value="${rowData[idx.qty] || ''}" onchange="handleQtyChange(this, ${componentId})"></td>`;
            rowHTML += `<td><button class="delete-row-btn" title="この行を削除" onclick="this.closest('tr').remove(); recalculateAllSalesData(${componentId})">🗑️</button></td>`;
            rowHTML += '</tr>';
            return rowHTML;
        }


        // 販売点数の変更を処理する関数
        function handleQtyChange(qtyInput, componentId) {
            const row = qtyInput.closest('tr');
            const productCode = row.dataset.productCode;
            const newQty = parseInt(qtyInput.value, 10);

            if (isNaN(newQty) || newQty <= 0) {
                row.remove();
            } else {
                const unitPrice = productMasterData.get(productCode)?.price;
                if (typeof unitPrice !== 'number') {
                    showToast(`エラー: 商品コード「${productCode}」の単価がマスタにありません。売上は更新されません。`, 'error');
                } else {
                    const salesCell = row.cells[3].querySelector('input');
                    const netSalesCell = row.cells[4].querySelector('input');
                    const newNetSales = unitPrice * newQty;
                    const newSales = Math.floor(newNetSales * 1.1); // 仮税率10%
                    
                    salesCell.value = newSales;
                    netSalesCell.value = newNetSales;
                }
            }
            recalculateAllSalesData(componentId);
        }

        // 売上関連の再計算をすべて行う関数
        function recalculateAllSalesData(componentId) {
            const table = document.getElementById('table_' + componentId)?.querySelector('.data-table');
            if (!table) return;

            let grandTotalSales = 0;
            let grandTotalNetSales = 0;
            let grandTotalQty = 0;
            
            const rows = table.querySelectorAll('tbody tr:not(.totals-row)');
            
            rows.forEach(row => {
                grandTotalNetSales += parseFloat(row.cells[4].querySelector('input').value) || 0;
            });

            rows.forEach(row => {
                const netSales = parseFloat(row.cells[4].querySelector('input').value) || 0;
                const ratioCell = row.cells[5];
                const ratio = (grandTotalNetSales > 0) ? ((netSales / grandTotalNetSales) * 100).toFixed(2) : "0.00";
                ratioCell.textContent = ratio;

                grandTotalQty += parseInt(row.cells[6].querySelector('input').value, 10) || 0;
                grandTotalSales += parseFloat(row.cells[3].querySelector('input').value) || 0;
            });
            
            const totalsRow = table.querySelector('.totals-row');
            if (totalsRow) {
                totalsRow.querySelector('[data-total="sales"]').textContent = `¥${grandTotalSales.toLocaleString()}`;
                totalsRow.querySelector('[data-total="netSales"]').textContent = `¥${grandTotalNetSales.toLocaleString()}`;
                totalsRow.querySelector('[data-total="qty"]').textContent = `${grandTotalQty.toLocaleString()}点`;
            }
        }
        
        function generateChart(chartType) {
            const data = csvData[chartType];
            if (!data || data.length < 2) return `<div><p>データを入力してください</p></div>`;
            
            const headers = data[0];
            const findIndex = (possibleNames) => {
                for (const name of possibleNames) {
                    const index = headers.indexOf(name);
                    if (index !== -1) return index;
                }
                return -1;
            };
            const labelIndex = findIndex(['客層名', '分類']);
            const valueIndex = findIndex(['客数']);

            if (labelIndex === -1 || valueIndex === -1) {
                return `<div><p>CSVに「客層名」または「客数」の列が見つかりません</p></div>`;
            }

            const items = [];
            let total = 0;
            data.slice(1).forEach(row => {
                const label = row[labelIndex]?.trim();
                const value = parseInt(row[valueIndex]?.replace(/,/g, ''), 10) || 0;
                if (label && value > 0) {
                    items.push({ label, value });
                    total += value;
                }
            });

            if (items.length === 0) return `<div><p>有効なデータがありません</p></div>`;
            
            const colors = ['#dc3912', '#ff9900', '#109618', '#990099', '#0099c6', '#dd4477', '#66aa00', '#b82e2e'];
            let chartHtml = `<div style="display: flex; align-items: center; justify-content: center; gap: 20px; margin-top: 20px;">`;
            let svgPaths = '';
            let currentAngle = -90;
            items.forEach((item, i) => {
                const angle = (item.value / total) * 360;
                const x1 = 150 + 120 * Math.cos(currentAngle * Math.PI / 180), y1 = 150 + 120 * Math.sin(currentAngle * Math.PI / 180);
                currentAngle += angle;
                const x2 = 150 + 120 * Math.cos(currentAngle * Math.PI / 180), y2 = 150 + 120 * Math.sin(currentAngle * Math.PI / 180);
                svgPaths += `<path d="M 150 150 L ${x1} ${y1} A 120 120 0 ${angle > 180 ? 1 : 0} 1 ${x2} ${y2} Z" fill="${colors[i % colors.length]}"></path>`;
            });
            chartHtml += `<div style="flex-shrink: 0;"><svg width="300" height="300" viewBox="0 0 300 300">${svgPaths}</svg></div>`;
            let legendHtml = '<div style="flex: 1; text-align: left;">';
            items.forEach((item, i) => {
                legendHtml += `<div style="display: flex; align-items: center; margin-bottom: 8px;">
                               <div style="width: 16px; height: 16px; background-color: ${colors[i % colors.length]}; margin-right: 8px; border-radius: 2px;"></div>
                               <input type="text" value="${item.label}" style="border: none; padding: 2px 6px; margin-right: 8px; font-size: 14px; background: white; width: 120px;">
                               <span style="font-size: 14px; color: #2c3e50; font-weight: bold;">${item.value}人 (${((item.value / total) * 100).toFixed(1)}%)</span></div>`;
            });
            chartHtml += legendHtml + '</div></div>';
            return chartHtml;
        }

        function updateChart(componentId) {
            const chartType = document.getElementById(`chartType_${componentId}`).value;
            document.getElementById('chart_' + componentId).innerHTML = generateChart(chartType);
        }
        function createImageUploadInputs(id, count) { let h = ''; for (let i = 1; i <= count; i++) { h += `<div class="form-group" style="border-top: 1px solid #eee; padding-top: 15px; margin-top: 15px;"><label>画像ファイル ${i}</label><input type="file" accept="image/*" id="imageFile${i}_${id}" onchange="handleMultiImageUpload(${id}, ${i})"><label style="margin-top:10px;">画像 ${i} の説明文</label><textarea rows="2" id="imageCaption${i}_${id}" placeholder="この画像の説明..." oninput="updateImageDisplay(${id})"></textarea></div>`; } return h; }
        function updateImageLayout(id) { const l = document.getElementById('imageLayout_' + id).value; document.getElementById('imageUploadArea_' + id).innerHTML = createImageUploadInputs(id, l === 'single' ? 1 : l === 'two' ? 2 : 3); updateImageDisplay(id); }
        function handleMultiImageUpload(id, idx) { const f = document.getElementById(`imageFile${idx}_${id}`); if (!f.files[0]) return; const r = new FileReader(); r.onload = e => { if (!window.imageData[id]) window.imageData[id] = {}; window.imageData[id][idx] = e.target.result; updateImageDisplay(id); }; r.readAsDataURL(f.files[0]); }
        function updateImageDisplay(id) { const p = document.getElementById('imagePreview_' + id); const d = window.imageData[id] || {}; if (Object.keys(d).length === 0) { p.innerHTML = '<p>画像をアップロードしてください</p>'; return; } let h = '<div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">'; Object.keys(d).sort().forEach(idx => { const cap = document.getElementById(`imageCaption${idx}_${id}`)?.value.replace(/\n/g, '<br>') || ''; h += `<div style="flex: 1; min-width: 200px; max-width: 300px; text-align: center;"><img src="${d[idx]}" style="width: 100%; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);"><p style="font-size: 0.9em; color: #666; margin-top: 8px; text-align: left;">${cap}</p></div>`; }); p.innerHTML = h + '</div>'; }
        function updateTextLayout(id) { document.getElementById(`textImageOptions_${id}`).style.display = document.getElementById(`textLayout_${id}`).value === 'text-only' ? 'none' : 'block'; updateTextBlockDisplay(id); }
        function handleTextBlockImageUpload(id) { const f = document.getElementById(`textImageFile_${id}`); if (!f.files[0]) return; const r = new FileReader(); r.onload = e => { window.textImageData[id] = e.target.result; updateTextBlockDisplay(id); }; r.readAsDataURL(f.files[0]); }
        function updateTextBlockDisplay(id) { const p = document.getElementById(`textPreview_${id}`); const l = document.getElementById(`textLayout_${id}`).value; const c = document.getElementById(`content_${id}`).value.replace(/\n/g, '<br>'); if (l === 'text-only') { p.innerHTML = c; return; } const iS = document.getElementById(`textImageSize_${id}`).value; const iD = window.textImageData[id]; let iH = iD ? `<div class="image-part" style="flex-basis: ${iS}; flex-shrink: 0;"><img src="${iD}" style="width: 100%; border-radius: 8px;"></div>` : `<div class="image-part" style="flex-basis: ${iS}; flex-shrink: 0; border: 2px dashed #ccc; display:flex; align-items:center; justify-content:center; min-height:100px; color:#999;">画像</div>`; const tH = `<div class="text-part" style="flex: 1;">${c}</div>`; p.innerHTML = `<div style="display: flex; gap: 20px; align-items: flex-start; flex-direction: ${l === 'text-image-right' ? 'row' : 'row-reverse'};">${l === 'text-image-right' ? tH + iH : iH + tH}</div>`; }
        function loadSalesData(id) {
            const data = csvData.transaction;
            if (!data || data.length < 2) { showToast('取引データが未入力です', 'error'); return; }
            try {
                const headers = data[0];
                const salesIndex = headers.indexOf('純売上(税抜)');
                const customerIndex = headers.indexOf('取引ID');

                if (salesIndex === -1 || customerIndex === -1) {
                    throw new Error('取引データCSVに「取引ID」または「純売上(税抜)」列が見つかりません。');
                }

                const salesData = data.slice(1);
                const totalSales = salesData.reduce((sum, row) => sum + (parseFloat(row[salesIndex]) || 0), 0);
                const customerSet = new Set(salesData.map(row => row[customerIndex]).filter(Boolean));
                const customerCount = customerSet.size;
                const avgPrice = customerCount > 0 ? Math.floor(totalSales / customerCount) : 0;
                
                document.getElementById(`sales_${id}`).value = `¥${totalSales.toLocaleString()}`;
                document.getElementById(`customers_${id}`).value = `${customerCount}人`;
                document.getElementById(`avgprice_${id}`).value = `¥${avgPrice.toLocaleString()}`;
                showToast('売上情報を計算しました');
            } catch (e) {
                showToast(`計算エラー: ${e.message}`, 'error');
            }
        }
        function moveUp(btn) { const c = btn.closest('.report-component'); if (c.previousElementSibling) c.parentNode.insertBefore(c, c.previousElementSibling); }
        function moveDown(btn) { const c = btn.closest('.report-component'); if (c.nextElementSibling) c.parentNode.insertBefore(c.nextElementSibling, c); }
        function deleteComponent(btn) { const c = btn.closest('.report-component'); if (confirm(`「${c.querySelector('h4').textContent}」を削除しますか？`)) { c.remove(); if (document.getElementById('dropZone').children.length === 0) { document.getElementById('dropZone').innerHTML = `<div class="drop-zone-placeholder"><i>📦</i><h3>コンポーネントを...</h3></div>`; } } }
        function clearCanvas() { if (confirm('すべてのコンポーネントを削除しますか？')) { document.getElementById('dropZone').innerHTML = `<div class="drop-zone-placeholder"><i>📦</i><h3>コンポーネントを...</h3></div>`; showToast('キャンバスをクリアしました'); } }
        function previewReport() { if (document.querySelectorAll('.report-component').length === 0) { showToast('プレビュー対象がありません', 'error'); return; } const win = window.open('', '_blank'); win.document.write(generatePrintPreviewContent()); win.document.close(); }
        function printReport() { if (document.querySelectorAll('.report-component').length === 0) { showToast('印刷対象がありません', 'error'); return; } const win = window.open('', '_blank'); win.document.write(generatePrintPreviewContent()); win.document.close(); setTimeout(() => { win.print(); win.close(); }, 500); }
        function generatePrintPreviewContent() {
            let content = `<!DOCTYPE html><html lang="ja"><head><title>レポート</title>
            <link rel="preconnect" href="https://fonts.googleapis.com">
            <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
            <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">
            <style>
                body { font-family: 'Noto Serif JP', serif; line-height: 1.7; background: white; color: #333; counter-reset: section-counter; }
                @page { size: A4 landscape; margin: 15mm; }
                * { -webkit-print-color-adjust: exact !important; color-adjust: exact !important; }
                .report-container { width: 100%; margin: 0 auto; }
                h1 { font-size: 24pt; text-align: center; color: #333; margin: 0; font-weight: 700;}
                h2 { font-family: 'Hiragino Sans', sans-serif; font-size: 16pt; font-weight: bold; color: #333; background-color: #efefef; padding: 8px; margin-top: 25px; margin-bottom: 20px; page-break-after: avoid; display: flex; align-items: center; }
                h2::before { counter-increment: section-counter; content: "0" counter(section-counter); background-color: #dc3912; color: white; padding: 8px 12px; margin-right: 15px; font-size: 1.2em; font-weight: bold; }
                h3 { font-size: 13pt; color: #333; border-bottom: 2px solid #efefef; padding-bottom: 5px; margin-top: 20px; margin-bottom: 10px; page-break-after: avoid; font-weight: 700; }
                p { margin-bottom: 15px; font-size: 11pt; }
                .section { margin-bottom: 20px; page-break-inside: avoid; }
                .report-header { text-align: center; margin-bottom: 40px; page-break-after: avoid; }
                .report-header p { font-size: 12pt; margin: 5px 0; }
                .report-header .period { font-size: 11pt; color: #666; }
                .sales-summary-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 12pt; }
                .sales-summary-table td { border: 1px solid #ddd; padding: 12px; text-align: center; width: 33.33%; background-color: #fafafa; }
                .sales-summary-table td strong { color: #333; display: block; margin-bottom: 5px; font-size: 11pt; font-weight: bold; }
                .data-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 9pt; }
                .data-table th, .data-table td { padding: 8px 10px; border: 1px solid #ccc; text-align: left; vertical-align: middle; }
                .data-table th { background: #efefef; font-weight: bold; font-family: 'Hiragino Sans', sans-serif; }
                .data-table tr[style*="font-weight:bold"] { background-color: #efefef !important; font-weight: bold; font-size: 10pt; }
                .data-table .delete-row-btn { display: none; }
                .demographics-container { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; page-break-inside: avoid; }
                .chart-and-legend { display: flex; justify-content: center; align-items: center; gap: 30px; width: 100%; margin-bottom: 20px; }
                .chart-part { flex: 1; text-align: right; max-width: 400px; }
                .chart-part svg { width: 100%; height: auto; }
                .legend-part-wrapper { flex: 1; text-align: left; }
                .legend-part { column-count: 1; }
                .legend-item { display: flex; align-items: center; margin-bottom: 8px; font-size: 10pt; page-break-inside: avoid; }
                .legend-color { width: 16px; height: 16px; margin-right: 10px; border-radius: 3px; flex-shrink: 0; }
                .legend-label { margin-right: 10px; }
                .legend-value { font-weight: bold; }
                .analysis-comment-wrapper { margin: 0 auto; width: 80%; text-align: left; }
                .text-content, .comment-part, .event-review-body { white-space: pre-wrap; line-height: 1.8; font-size: 11pt; background: #ffffff; padding: 20px; border-radius: 5px; margin-top: 10px; border: 1px solid #efefef; text-align: left;}
                .image-section-wrapper { display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 80vh; text-align: center; }
                .image-section { margin-top: 20px; }
                .image-section .image-block { display: inline-block; margin: 10px; text-align: left; vertical-align: top; width: 30%; }
                .image-section img { max-width: 100%; height: auto; border: 1px solid #ddd; padding: 4px; margin-bottom: 5px; }
                .image-section p { font-size: 9pt; color: #555; text-align: center; }
                .text-block-content .text-image-container { display:flex; gap: 20px; align-items: flex-start; }
                .text-block-content .image-part { flex-shrink: 0; }
                .text-block-content .image-part img { width: 100%; height: auto; border-radius: 8px; }
                .text-block-content .text-part { flex: 1; }
            </style></head><body><div class="report-container">`;
            document.querySelectorAll('.report-component').forEach((component) => {
                const {type, id} = component.dataset;
                try {
                    switch (type) {
                        case 'header': content += `<div class="section"><div class="report-header"><h1>${document.getElementById(`event_${id}`).value}</h1><p>${document.getElementById(`company_${id}`).value} ${document.getElementById(`honorific_${id}`).value}</p><p class="period">${document.getElementById(`period_${id}`).value}</p></div></div>`; break;
                        case 'sales-summary': content += `<div class="section"><h2>売上サマリー（MD全体の売上）</h2><table class="sales-summary-table"><tr><td><strong>純売上(税抜)</strong> ${document.getElementById(`sales_${id}`).value}</td><td><strong>購入客数</strong> ${document.getElementById(`customers_${id}`).value}</td><td><strong>平均購入単価</strong> ${document.getElementById(`avgprice_${id}`).value}</td></tr></table></div>`; break;
                        case 'event-review': content += `<div class="section page-break-before"><h2>MD全体の振り返り</h2>`; component.querySelectorAll('.review-item').forEach(item => { const title = item.querySelector('.review-item-title').value; const reviewContent = item.querySelector('.review-item-content').value.replace(/\n/g, '<br>'); if (title || reviewContent) { content += `<h3>${title}</h3><div class="event-review-body">${reviewContent}</div>`; } }); content += `</div>`; break;
                        case 'product-table': content += `<div class="section page-break-before"><h2>商品別売上表</h2>`; const tableNode = component.querySelector('.data-table'); if (tableNode) { const clonedTable = tableNode.cloneNode(true); clonedTable.querySelectorAll('input.editable-cell').forEach(input => { const text = document.createTextNode(input.value); input.parentNode.replaceChild(text, input); }); clonedTable.querySelector('thead tr').lastChild.remove(); clonedTable.querySelectorAll('tbody tr').forEach(tr => { if(tr.lastChild) tr.lastChild.remove(); }); content += clonedTable.outerHTML; } content += `</div>`; break;
                        case 'demographics-chart': content += `<div class="section page-break-before"><h2>客層分析 (${document.querySelector(`#chartType_${id} option:checked`).textContent})</h2>`; const chartContainer = document.getElementById(`chart_${id}`); if (chartContainer) { let legendHtml = ''; chartContainer.querySelectorAll('div[style*="display: flex"] > div:last-child > div').forEach(item => { const color = item.querySelector('div[style*="background-color"]').style.backgroundColor; const label = item.querySelector('input[type="text"]').value; const value = item.querySelector('span').textContent; legendHtml += `<div class="legend-item"><div class="legend-color" style="background-color: ${color};"></div><span class="legend-label">${label}</span><span class="legend-value">${value}</span></div>`; }); const commentText = document.getElementById(`comment_${id}`).value; content += `<div class="demographics-container"><div class="chart-and-legend"><div class="chart-part">${chartContainer.querySelector('svg')?.outerHTML || ''}</div><div class="legend-part-wrapper"><div class="legend-part">${legendHtml}</div></div></div>`; if (commentText.trim() !== '') { content += `<div class="analysis-comment-wrapper"><h3>分析コメント</h3><div class="comment-part">${commentText.replace(/\n/g, '<br>')}</div></div>`; } content += `</div>`; } content += `</div>`; break;
                        case 'image': content += `<div class="section image-section-wrapper page-break-before"><div><h2>${document.getElementById(`imageTitle_${id}`).value}</h2><div class="image-section">${document.getElementById(`imagePreview_${id}`).innerHTML.replace(/<div style="flex: 1[^>]+>/g, '<div class="image-block">')}</div></div></div></div>`; break;
                        case 'customer-voice': content += `<div class="section page-break-before"><h2>お客様の声</h2><div class="text-content">${document.getElementById(`voice_${id}`).value.replace(/\n/g, '<br>')}</div></div>`; break;
                        case 'staff-comments': content += `<div class="section page-break-before"><h2>スタッフ所感</h2><div class="text-content">${document.getElementById(`staff_${id}`).value.replace(/\n/g, '<br>')}</div></div>`; break;
                        case 'text-block': const title = document.getElementById(`title_${id}`).value; const layout = document.getElementById(`textLayout_${id}`).value; const textContent = document.getElementById(`content_${id}`).value.replace(/\n/g, '<br>'); const imageSrc = window.textImageData[id]; content += `<div class="section page-break-before"><h2>${title}</h2>`; if (layout === 'text-only' || !imageSrc) { content += `<div class="text-block-content">${textContent}</div>`; } else { const imageSize = document.getElementById(`textImageSize_${id}`).value; const textPart = `<div class="text-part">${textContent}</div>`; const imagePart = `<div class="image-part" style="flex-basis: ${imageSize};"><img src="${imageSrc}"></div>`; content += `<div class="text-block-content"><div class="text-image-container">${layout === 'text-image-left' ? imagePart + textPart : textPart + imagePart}</div></div>`; } content += `</div>`; break;
                    }
                } catch (e) { content += `<p style="color:red;">エラー: ${e.message}</p>`; }
            });
            content += '</div></body></html>';
            return content;
        }
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            if (!toast) return;
            toast.textContent = message;
            toast.style.background = type === 'error' ? '#e74c3c' : '#27ae60';
            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 3000);
        }
        document.addEventListener('DOMContentLoaded', () => {
            initDragDrop();
            setupFileUploads();
            showToast('📊 レポートビルダーへようこそ！');
        });
    </script>
</body>
</html>
