<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¡ãƒ¼ã‚«ãƒ¼åˆ¥å£²ä¸Šãƒ¬ãƒãƒ¼ãƒˆ ãƒ“ãƒ«ãƒ€ãƒ¼ - æ”¹è‰¯ç‰ˆ</title>
    <style>
        /* --- å…¨ä½“ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Hiragino Sans', 'Yu Gothic UI', sans-serif;
            background: #f0f2f5; /* èƒŒæ™¯ã‚’ã‚·ãƒ³ãƒ—ãƒ«ã« */
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: #dc3912; /* ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã«å¤‰æ›´ */
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .header p { font-size: 1.2em; opacity: 0.9; }
        
        .main-content { 
            display: flex; 
            min-height: calc(100vh - 120px);
            align-items: flex-start;
            max-height: calc(100vh - 120px);
            overflow: hidden;
        }
        
        /* --- ã‚µã‚¤ãƒ‰ãƒãƒ¼ --- */
        .sidebar {
            width: 320px;
            background: #f8f9fa;
            border-right: 2px solid #efefef; /* ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã«å¤‰æ›´ */
            padding: 20px;
            overflow-y: auto;
            height: calc(100vh - 120px);
            position: sticky;
            top: 0;
            flex-shrink: 0;
        }
        
        .sidebar h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #dc3912; /* ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã«å¤‰æ›´ */
        }
        
        .data-upload-section {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #efefef; /* ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã«å¤‰æ›´ */
        }
        
        .upload-item { margin-bottom: 15px; }
        
        .upload-item label {
            display: block;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        
        .upload-item input[type="file"] {
            width: 100%; padding: 8px; border: 2px dashed #bdc3c7; border-radius: 5px;
            background: #fafafa; transition: all 0.3s ease;
        }
        
        .upload-item input[type="file"]:hover { border-color: #dc3912; background: #fff8f5; }
        
        .upload-status { font-size: 0.8em; margin-top: 5px; padding: 5px; border-radius: 3px; }
        .upload-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        
        .component-library { display: flex; flex-direction: column; gap: 10px; }
        
        .component-item {
            background: white; padding: 15px; border-radius: 8px; border: 2px solid #efefef;
            cursor: grab; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .component-item:hover {
            transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15);
            border-color: #dc3912; /* ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã«å¤‰æ›´ */
        }
        
        .component-item h4 { color: #2c3e50; margin-bottom: 5px; font-size: 0.9em; }
        .component-item p { color: #6c757d; font-size: 0.8em; line-height: 1.4; }
        
        /* --- ã‚­ãƒ£ãƒ³ãƒã‚¹ï¼ˆç·¨é›†ã‚¨ãƒªã‚¢ï¼‰ --- */
        .canvas {
            flex: 1; padding: 20px; background: #fff;
            overflow-y: auto; height: calc(100vh - 120px);
        }
        
        .canvas-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 30px; padding-bottom: 15px; border-bottom: 2px solid #e9ecef;
        }
        
        .canvas-title { font-size: 1.5em; color: #2c3e50; }
        .canvas-actions { display: flex; gap: 10px; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 25px; cursor: pointer; font-weight: bold; transition: all 0.3s ease; font-size: 0.9em; }
        .btn-primary { background: #dc3912; color: white; } /* ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã«å¤‰æ›´ */
        .btn-primary:hover { background: #c53210; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(220, 57, 18, 0.3); }
        .btn-secondary { background: #95a5a6; color: white; }
        .btn-secondary:hover { background: #7f8c8d; transform: translateY(-2px); }
        
        .drop-zone { min-height: 500px; border: 3px dashed #bdc3c7; border-radius: 10px; padding: 20px; background: #fafafa; transition: all 0.3s ease; }
        .drop-zone.drag-over { border-color: #dc3912; background: #fff8f5; } /* ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã«å¤‰æ›´ */
        .drop-zone-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #95a5a6; text-align: center; }
        .drop-zone-placeholder i { font-size: 4em; margin-bottom: 20px; opacity: 0.3; }
        
        /* --- ãƒ¬ãƒãƒ¼ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
        .report-component {
            background: white; margin-bottom: 20px; border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); overflow: hidden;
            border: 2px solid transparent; transition: all 0.3s ease;
        }
        
        .report-component:hover {
            border-color: #dc3912; /* ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã«å¤‰æ›´ */
            transform: translateY(-2px); box-shadow: 0 8px 16px rgba(0,0,0,0.15);
        }
        
        .component-header {
            background: #34495e; /* ãƒ¡ã‚¤ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼ã¨åŒºåˆ¥ */
            color: white; padding: 15px 20px; display: flex;
            justify-content: space-between; align-items: center;
        }
        
        .component-header h4 { margin: 0; font-size: 1.1em; }
        .component-controls { display: flex; gap: 8px; }
        
        .control-btn {
            background: rgba(255,255,255,0.2); border: none; color: white; width: 30px; height: 30px;
            border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;
        }
        .control-btn:hover { background: rgba(255,255,255,0.3); transform: scale(1.1); }
        .component-content { padding: 20px; }
        
        /* --- ãƒ•ã‚©ãƒ¼ãƒ è¦ç´  --- */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: #2c3e50; font-weight: bold; }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 5px;
            font-family: inherit; transition: border-color 0.3s ease;
        }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: #dc3912; } /* ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã«å¤‰æ›´ */
        
        .review-item {
            padding: 15px;
            border: 1px solid #efefef;
            border-radius: 5px;
            margin-bottom: 10px;
            background: #fafafa;
        }

        .add-product-area {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background-color: #f8f9fa;
        }
        .add-product-area label {
             font-size: 0.9em;
             margin-bottom: 8px;
        }

        /* --- ãƒãƒ£ãƒ¼ãƒˆã¨ãƒ†ãƒ¼ãƒ–ãƒ« --- */
        .chart-container { background: #f8f9fa; border-radius: 8px; padding: 20px; text-align: center; min-height: 200px; display: flex; align-items: center; justify-content: center; color: #6c757d; }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .data-table th, .data-table td { padding: 12px; text-align: left; border-bottom: 1px solid #e9ecef; }
        .data-table th { background: #f8f9fa; font-weight: bold; color: #2c3e50; }
        .data-table tr:hover { background: #f8f9fa; }
        
        .editable-cell {
            border: none;
            background-color: transparent;
            width: 100%;
            padding: 0;
            margin: 0;
            font-size: inherit;
            font-family: inherit;
        }
        .editable-cell:focus {
            outline: 1px solid #dc3912;
            background-color: #fff8f5;
        }

        .delete-row-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 18px;
            padding: 0 5px;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        .delete-row-btn:hover { opacity: 1; color: #e74c3c; }


        /* --- ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ --- */
        .toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: #27ae60; color: white; padding: 15px 25px; border-radius: 25px;
            box-shadow: 0 6px 12px rgba(0,0,0,0.15); z-index: 1001; display: none;
        }
        
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ãƒ¡ãƒ¼ã‚«ãƒ¼åˆ¥å£²ä¸Šãƒ¬ãƒãƒ¼ãƒˆ ãƒ“ãƒ«ãƒ€ãƒ¼</h1>
            <p>CSVç›´æ¥å…¥åŠ›å¯¾å¿œï½œãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§è‡ªç”±ã«ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º</p>
        </div>
        
        <div class="main-content">
            <div class="sidebar">
                <div class="data-upload-section">
                    <h3>ğŸ“ ãƒ‡ãƒ¼ã‚¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h3>
                    <div class="upload-item"><label>ã€å¿…é ˆã€‘å•†å“ãƒã‚¹ã‚¿ (ã‚¹ãƒãƒ¬ã‚¸CSV)</label><input type="file" accept=".csv" id="productMasterUpload"><div id="status-productMaster" class="upload-status" style="display: none;"></div></div>
                    <div class="upload-item"><label>ã€å¿…é ˆã€‘å•†å“åˆ¥å£²ä¸Šãƒ‡ãƒ¼ã‚¿ (CSV)</label><input type="file" accept=".csv" id="productSalesUpload"><div id="status-productSales" class="upload-status" style="display: none;"></div></div>
                    <div class="upload-item"><label>ã€ä»»æ„ã€‘å–å¼•ãƒ‡ãƒ¼ã‚¿ (CSV)</label><input type="file" accept=".csv" id="transactionUpload"><div id="status-transaction" class="upload-status" style="display: none;"></div></div>
                    <div class="upload-item"><label>ã€ä»»æ„ã€‘å®¢å±¤åˆ¥å£²ä¸Š - å¹´ä»£ (CSV)</label><input type="file" accept=".csv" id="ageUpload"><div id="status-age" class="upload-status" style="display: none;"></div></div>
                    <div class="upload-item"><label>ã€ä»»æ„ã€‘å®¢å±¤åˆ¥å£²ä¸Š - æ€§åˆ¥ (CSV)</label><input type="file" accept=".csv" id="genderUpload"><div id="status-gender" class="upload-status" style="display: none;"></div></div>
                    <div class="upload-item"><label>ã€ä»»æ„ã€‘å®¢å±¤åˆ¥å£²ä¸Š - æ¥åº—å›æ•° (CSV)</label><input type="file" accept=".csv" id="visitFrequencyUpload"><div id="status-visitFrequency" class="upload-status" style="display: none;"></div></div>
                    <div class="upload-item"><label>ã€ä»»æ„ã€‘å®¢å±¤åˆ¥å£²ä¸Š - æ¥åº—ç›®çš„ (CSV)</label><input type="file" accept=".csv" id="visitPurposeUpload"><div id="status-visitPurpose" class="upload-status" style="display: none;"></div></div>
                </div>
                
                <h3>ğŸ“¦ ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ</h3>
                <div class="component-library">
                    <div class="component-item" draggable="true" data-type="header"><h4>â—† ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±</h4><p>ä¼šç¤¾åãƒ»æœŸé–“ãƒ»ã‚¿ã‚¤ãƒˆãƒ«ãªã©</p></div>
                     <div class="component-item" draggable="true" data-type="sales-summary"><h4>â—† å£²ä¸Šã‚µãƒãƒªãƒ¼ (ã‚¤ãƒ™ãƒ³ãƒˆå…¨ä½“)</h4><p>ç·å£²ä¸Šãƒ»å®¢æ•°ãƒ»å¹³å‡å˜ä¾¡</p></div>
                     <div class="component-item" draggable="true" data-type="event-review"><h4>â—† MDå…¨ä½“ã®æŒ¯ã‚Šè¿”ã‚Š</h4><p>ç•ªå·ãªã—ã®è¦‹å‡ºã—ã¨ã‚³ãƒ¡ãƒ³ãƒˆ</p></div>
                    <div class="component-item" draggable="true" data-type="product-table"><h4>â—† å•†å“åˆ¥å£²ä¸Šè¡¨</h4><p>å•†å“åãƒ»è²©å£²æ•°ãƒ»å£²ä¸Šä¸€è¦§</p></div>
                    <div class="component-item" draggable="true" data-type="demographics-chart"><h4>â—† å®¢å±¤åˆ†æãƒãƒ£ãƒ¼ãƒˆ</h4><p>å¹´ä»£ãƒ»æ€§åˆ¥ãƒ»æ¥åº—å›æ•°ãªã©</p></div>
                    <div class="component-item" draggable="true" data-type="image"><h4>â—† å†™çœŸãƒ»ç”»åƒ</h4><p>å•†å“å†™çœŸãƒ»ã‚¤ãƒ™ãƒ³ãƒˆå†™çœŸãªã©</p></div>
                    <div class="component-item" draggable="true" data-type="customer-voice"><h4>â—† ãŠå®¢æ§˜ã®å£°</h4><p>ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆ</p></div>
                    <div class="component-item" draggable="true" data-type="staff-comments"><h4>â—† ã‚¹ã‚¿ãƒƒãƒ•æ‰€æ„Ÿ</h4><p>æ”¹å–„ææ¡ˆãƒ»æ°—ã¥ã</p></div>
                    <div class="component-item" draggable="true" data-type="text-block"><h4>â—† è‡ªç”±ãƒ†ã‚­ã‚¹ãƒˆ</h4><p>ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„</p></div>
                </div>
            </div>
            
            <div class="canvas">
                <div class="canvas-header">
                    <div class="canvas-title">ãƒ¬ãƒãƒ¼ãƒˆç·¨é›†ã‚¨ãƒªã‚¢</div>
                    <div class="canvas-actions">
                        <button class="btn btn-secondary" onclick="clearCanvas()">ğŸ—‘ï¸ ã‚¯ãƒªã‚¢</button>
                        <button class="btn btn-primary" onclick="previewReport()">ğŸ‘ï¸ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
                        <button class="btn btn-primary" onclick="printReport()" style="background: #e74c3c;">ğŸ–¨ï¸ PDFå°åˆ·</button>
                    </div>
                </div>
                
                <div class="drop-zone" id="dropZone">
                    <div class="drop-zone-placeholder"><i>ğŸ“¦</i><h3>ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</h3><p>å·¦ã®ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‹ã‚‰ãŠå¥½ã¿ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’è¿½åŠ ã—ã¦ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã§ãã¾ã™</p></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        var csvData = {};
        var productMasterData = new Map(); // å•†å“ãƒã‚¹ã‚¿ï¼ˆå˜ä¾¡æƒ…å ±ï¼‰ã‚’ä¿æŒ
        var componentCounter = 0;
        var draggedElement = null;
        window.imageData = {};
        window.textImageData = {};

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        function setupFileUploads() {
            var fileInputs = [
                {id: 'productMasterUpload', type: 'productMaster'},
                {id: 'productSalesUpload', type: 'productSales'},
                {id: 'transactionUpload', type: 'transaction'},
                {id: 'ageUpload', type: 'age'},
                {id: 'genderUpload', type: 'gender'},
                {id: 'visitFrequencyUpload', type: 'visitFrequency'},
                {id: 'visitPurposeUpload', type: 'visitPurpose'}
            ];
            
            fileInputs.forEach(function(item) {
                var input = document.getElementById(item.id);
                if (input) {
                    input.addEventListener('change', function(e) { handleFileUpload(e.target, item.type); });
                }
            });
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒãƒ³ãƒ‰ãƒ©
        function handleFileUpload(input, dataType) {
            if (!input.files || !input.files[0]) return;
            var file = input.files[0];
            var statusDiv = document.getElementById('status-' + dataType);
            statusDiv.innerHTML = 'â³ èª­ã¿è¾¼ã¿ä¸­...';
            statusDiv.className = 'upload-status';
            statusDiv.style.display = 'block';
            
            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = e.target.result.split(/\r?\n/).map(line => line.split(',').map(cell => cell.trim().replace(/^"|"$/g, ''))).filter(row => row.length > 1 && row.some(cell => cell));
                    if (data.length === 0) throw new Error('ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™');
                    
                    const headers = data[0];
                    if (dataType === 'productMaster') {
                        productMasterData.clear();
                        const findIndex = (possibleNames) => {
                            for (const name of possibleNames) {
                                const index = headers.indexOf(name);
                                if (index !== -1) return index;
                            }
                            return -1;
                        };
                        const idx = {
                            code: findIndex(['å•†å“ã‚³ãƒ¼ãƒ‰', 'å“ç•ª']),
                            name: findIndex(['å•†å“å']),
                            price: findIndex(['è²©å£²ä¾¡æ ¼', 'å˜ä¾¡', 'å•†å“å˜ä¾¡']),
                            group: findIndex(['ã‚°ãƒ«ãƒ¼ãƒ—ã‚³ãƒ¼ãƒ‰', 'ã‚°ãƒ«ãƒ¼ãƒ—', 'ãƒ¡ãƒ¼ã‚«ãƒ¼', 'ç¤¾å'])
                        };

                        if ([idx.code, idx.name, idx.price, idx.group].some(i => i === -1)) {
                             const missing = [];
                             if (idx.code === -1) missing.push("å•†å“ã‚³ãƒ¼ãƒ‰");
                             if (idx.name === -1) missing.push("å•†å“å");
                             if (idx.price === -1) missing.push("è²©å£²ä¾¡æ ¼/å•†å“å˜ä¾¡");
                             if (idx.group === -1) missing.push("ã‚°ãƒ«ãƒ¼ãƒ—ã‚³ãƒ¼ãƒ‰/ã‚°ãƒ«ãƒ¼ãƒ—");
                            throw new Error(`å•†å“ãƒã‚¹ã‚¿CSVã«å¿…é ˆã®åˆ—ï¼ˆ${missing.join(', ')}ï¼‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`);
                        }

                        data.slice(1).forEach(row => {
                            const productCode = row[idx.code];
                            const unitPrice = parseFloat(row[idx.price]);
                            if (productCode && !isNaN(unitPrice)) {
                                productMasterData.set(productCode, {
                                    name: row[idx.name],
                                    price: unitPrice,
                                    group: row[idx.group] || '',
                                    dept: '' 
                                });
                            }
                        });
                        statusDiv.innerHTML = `âœ… ${file.name} (${productMasterData.size}ä»¶) èª­ã¿è¾¼ã¿å®Œäº†`;
                        showToast(`å•†å“ãƒã‚¹ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ (${productMasterData.size}ä»¶)`);

                    } else {
                        csvData[dataType] = data;
                        statusDiv.innerHTML = `âœ… ${file.name} (${data.length - 1}è¡Œ) èª­ã¿è¾¼ã¿å®Œäº†`;
                        showToast(`${file.name} ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
                    }
                    
                    setTimeout(() => updateRelatedComponents(dataType), 100);

                } catch (error) {
                    statusDiv.innerHTML = `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                    showToast(error.message, 'error');
                }
            };
            reader.onerror = () => { statusDiv.innerHTML = 'âŒ ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼'; showToast('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼', 'error'); };
            reader.readAsText(file, 'Shift_JIS'); 
        }
        
        // ãƒ‡ãƒ¼ã‚¿æ›´æ–°æ™‚ã«é–¢é€£ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’æ›´æ–°
        function updateRelatedComponents(dataType) {
            if (['age', 'gender', 'visitFrequency', 'visitPurpose'].includes(dataType)) {
                document.querySelectorAll('.report-component[data-type="demographics-chart"]').forEach(component => {
                    const componentId = component.dataset.id;
                    const chartTypeSelect = document.getElementById('chartType_' + componentId);
                    if (chartTypeSelect && chartTypeSelect.value === dataType) { updateChart(componentId); }
                });
            } else if (dataType === 'productSales' || dataType === 'productMaster') {
                populateMakerOptions();
            }
        }
        
        function initDragDrop() {
            document.querySelectorAll('.component-item').forEach(item => {
                item.addEventListener('dragstart', e => { draggedElement = e.target; });
            });
            const dropZone = document.getElementById('dropZone');
            dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
            dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
            dropZone.addEventListener('drop', e => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
                if (draggedElement) { addComponent(draggedElement.dataset.type); }
            });
        }
        
        // ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¿½åŠ 
        function addComponent(type) {
            componentCounter++;
            const dropZone = document.getElementById('dropZone');
            const placeholder = dropZone.querySelector('.drop-zone-placeholder');
            if (placeholder) placeholder.remove();
            
            const component = createComponent(type, componentCounter);
            dropZone.appendChild(component);
            showToast(getComponentName(type) + ' ã‚’è¿½åŠ ã—ã¾ã—ãŸ');

            if (type === 'text-block') { updateTextBlockDisplay(componentCounter); }
            if (type === 'product-table' && csvData.productSales) { setTimeout(populateMakerOptions, 200); }
        }
        
        // ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®DOMã‚’ç”Ÿæˆ
        function createComponent(type, id) {
            const div = document.createElement('div');
            div.className = 'report-component';
            div.dataset.type = type;
            div.dataset.id = id;
            div.innerHTML = `
                <div class="component-header"><h4>${getComponentName(type)}</h4>
                    <div class="component-controls">
                        <button class="control-btn" onclick="moveUp(this)">â†‘</button>
                        <button class="control-btn" onclick="moveDown(this)">â†“</button>
                        <button class="control-btn" onclick="deleteComponent(this)">ğŸ—‘ï¸</button>
                    </div>
                </div>
                <div class="component-content">${getComponentContent(type, id)}</div>`;
            return div;
        }

        // ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåå–å¾—
        function getComponentName(type) {
            const names = {
                'header': 'â—† ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±', 'sales-summary': 'â—† å£²ä¸Šã‚µãƒãƒªãƒ¼ (ã‚¤ãƒ™ãƒ³ãƒˆå…¨ä½“)', 'product-table': 'â—† å•†å“åˆ¥å£²ä¸Šè¡¨',
                'demographics-chart': 'â—† å®¢å±¤åˆ†æãƒãƒ£ãƒ¼ãƒˆ', 'image': 'â—† å†™çœŸãƒ»ç”»åƒ', 'customer-voice': 'â—† ãŠå®¢æ§˜ã®å£°',
                'staff-comments': 'â—† ã‚¹ã‚¿ãƒƒãƒ•æ‰€æ„Ÿ', 'text-block': 'â—† è‡ªç”±ãƒ†ã‚­ã‚¹ãƒˆ', 'event-review': 'â—† MDå…¨ä½“ã®æŒ¯ã‚Šè¿”ã‚Š'
            };
            return names[type] || 'â“ ä¸æ˜ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ';
        }
        
        // ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„HTMLã‚’ç”Ÿæˆ
        function getComponentContent(type, id) {
             switch(type) {
                case 'header':
                    return `<div style="display: flex; gap: 15px; align-items: flex-end;">
                               <div class="form-group" style="flex: 1;">
                                   <label>ä¼šç¤¾å</label>
                                   <input type="text" value="æ ªå¼ä¼šç¤¾ã“ã—ã" id="company_${id}">
                               </div>
                               <div class="form-group" style="flex-basis: 100px;">
                                   <label>æ•¬ç§°</label>
                                   <select id="honorific_${id}">
                                       <option value="æ§˜">æ§˜</option>
                                       <option value="å¾¡ä¸­" selected>å¾¡ä¸­</option>
                                   </select>
                               </div>
                           </div>
                           <div class="form-group"><label>ã‚¤ãƒ™ãƒ³ãƒˆå</label><input type="text" value="ã‚¢ãƒŠã‚¶ãƒ¼ãƒ»å®®åŸ" id="event_${id}"></div>
                           <div class="form-group"><label>å®Ÿæ–½æœŸé–“</label><input type="text" value="2025å¹´4æœˆ29æ—¥(ç«)ã€œ5æœˆ18æ—¥(æ—¥) ã€20æ—¥é–“ã€‘" id="period_${id}"></div>`;
                case 'sales-summary':
                    return `<p style="font-size:0.9em; color:#666; margin-bottom:15px;">å–å¼•ãƒ‡ãƒ¼ã‚¿CSVã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€ã‚¤ãƒ™ãƒ³ãƒˆå…¨ä½“ã®å£²ä¸Šãªã©ãŒè‡ªå‹•ã§è¨ˆç®—ã•ã‚Œã¾ã™ã€‚</p>
                            <div class="form-group"><label>ç´”å£²ä¸Š(ç¨æŠœ)</label><input type="text" id="sales_${id}" readonly style="background:#eee;"></div>
                           <div class="form-group"><label>è³¼å…¥å®¢æ•°</label><input type="text" id="customers_${id}" readonly style="background:#eee;"></div>
                           <div class="form-group"><label>å¹³å‡è³¼å…¥å˜ä¾¡</label><input type="text" id="avgprice_${id}" readonly style="background:#eee;"></div>
                           <button class="btn btn-secondary" onclick="loadSalesData(${id})" style="margin-top: 10px;">å–å¼•ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è¨ˆç®—</button>`;
                case 'event-review':
                    return `<div id="review-items-container-${id}"></div>
                            <button class="btn btn-secondary" onclick="addReviewItem(${id})" style="margin-top: 10px;">ï¼‹ é …ç›®ã‚’è¿½åŠ </button>`;
                case 'product-table':
                    return `<div class="form-group"><label>å¯¾è±¡ãƒ¡ãƒ¼ã‚«ãƒ¼é¸æŠ</label><select id="makerSelect_${id}" onchange="updateProductTable(${id})"><option value="">ãƒ¡ãƒ¼ã‚«ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„</option></select></div>
                           <div id="table_${id}"><div style="padding: 20px; text-align: center; color: #666; border: 2px dashed #ddd; border-radius: 8px;"><h4>â—† å•†å“åˆ¥å£²ä¸Šè¡¨</h4><p>å•†å“ãƒã‚¹ã‚¿ã¨å•†å“åˆ¥å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€ãƒ¡ãƒ¼ã‚«ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„</p></div></div>
                           <div class="add-product-area" id="addProductArea_${id}" style="display:none;">
                                <label>ãƒ¬ã‚¸ãƒŸã‚¹ãªã©ã§è¨ˆä¸Šã•ã‚Œãªã‹ã£ãŸå•†å“ã‚’æ‰‹å‹•ã§è¿½åŠ </label>
                                <div style="display:flex; gap:10px;">
                                    <select id="addProductSelect_${id}" style="flex:1;"></select>
                                    <button class="btn btn-secondary" onclick="addProductFromMaster(${id})">å•†å“ã‚’è¿½åŠ </button>
                                </div>
                           </div>`;
                case 'demographics-chart':
                    return `<div class="form-group"><label>åˆ†æç¨®åˆ¥</label><select id="chartType_${id}" onchange="updateChart(${id})"><option value="age">å¹´ä»£åˆ¥</option><option value="gender">æ€§åˆ¥</option><option value="visitFrequency">æ¥åº—å›æ•°</option><option value="visitPurpose">æ¥åº—ç›®çš„</option></select></div><div class="chart-container" id="chart_${id}">${generateChart('age')}</div><div class="form-group"><label>åˆ†æã‚³ãƒ¡ãƒ³ãƒˆ</label><textarea rows="4" id="comment_${id}" placeholder="å®¢å±¤åˆ†æã‚³ãƒ¡ãƒ³ãƒˆ..."></textarea></div>`;
                case 'image':
                    return `<div class="form-group"><label>ç”»åƒã‚¿ã‚¤ãƒˆãƒ«</label><input type="text" value="å•†å“å†™çœŸ" id="imageTitle_${id}"></div><div class="form-group"><label>ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ</label><select id="imageLayout_${id}" onchange="updateImageLayout(${id})"><option value="single" selected>1æšè¡¨ç¤º</option><option value="two">2æšæ¨ªä¸¦ã³</option><option value="three">3æšæ¨ªä¸¦ã³</option></select></div><div id="imageUploadArea_${id}">${createImageUploadInputs(id, 1)}</div><div id="imagePreview_${id}" style="margin-top: 15px; border: 2px dashed #ddd; padding: 20px; border-radius: 8px; color: #666; text-align: center;"><p>ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„</p></div>`;
                case 'customer-voice':
                    return `<div class="form-group"><label>ãŠå®¢æ§˜ã®å£°</label><textarea rows="6" id="voice_${id}" placeholder="ãŠå®¢æ§˜ã‹ã‚‰ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯..." style="white-space: pre-wrap;"></textarea></div>`;
                case 'staff-comments':
                    return `<div class="form-group"><label>ã‚¹ã‚¿ãƒƒãƒ•ã‹ã‚‰ã®æ‰€æ„Ÿãƒ»ææ¡ˆ</label><textarea rows="6" id="staff_${id}" placeholder="è²©å£²æ´»å‹•ã§ã®æ°—ã¥ãã‚„æ”¹å–„ææ¡ˆ..." style="white-space: pre-wrap;"></textarea></div>`;
                case 'text-block':
                    return `<div class="form-group"><label>ã‚¿ã‚¤ãƒˆãƒ«</label><input type="text" value="ã‚«ã‚¹ã‚¿ãƒ ã‚»ã‚¯ã‚·ãƒ§ãƒ³" id="title_${id}" oninput="updateTextBlockDisplay(${id})"></div><div class="form-group"><label>ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ</label><select id="textLayout_${id}" onchange="updateTextLayout(${id})"><option value="text-only" selected>ãƒ†ã‚­ã‚¹ãƒˆã®ã¿</option><option value="text-image-right">ãƒ†ã‚­ã‚¹ãƒˆ(å·¦)ï¼‹ç”»åƒ(å³)</option><option value="text-image-left">ç”»åƒ(å·¦)ï¼‹ãƒ†ã‚­ã‚¹ãƒˆ(å³)</option></select></div><div class="form-group"><label>å†…å®¹</label><textarea rows="6" id="content_${id}" placeholder="è‡ªç”±ã«ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›..." oninput="updateTextBlockDisplay(${id})"></textarea></div><div id="textImageOptions_${id}" style="display:none; border-top: 1px solid #eee; padding-top: 15px;"><div class="form-group"><label>ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«</label><input type="file" accept="image/*" id="textImageFile_${id}" onchange="handleTextBlockImageUpload(${id})"></div><div class="form-group"><label>ç”»åƒã‚µã‚¤ã‚º</label><select id="textImageSize_${id}" onchange="updateTextBlockDisplay(${id})"><option value="30%">å° (30%)</option><option value="40%" selected>ä¸­ (40%)</option><option value="50%">å¤§ (50%)</option></select></div></div><div style="margin-top: 15px; font-weight: bold;">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼:</div><div id="textPreview_${id}" style="border: 2px dashed #ddd; padding: 20px; border-radius: 8px; min-height: 100px; line-height: 1.6;"></div>`;
                default:
                    return '<p>ä¸æ˜ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã™ã€‚</p>';
            }
        }

        function addReviewItem(componentId) {
            const container = document.getElementById(`review-items-container-${componentId}`);
            const newItem = document.createElement('div');
            newItem.className = 'review-item';
            newItem.innerHTML = `<div class="form-group"><label>è¦‹å‡ºã—</label><input type="text" class="review-item-title" placeholder="æŒ¯ã‚Šè¿”ã‚Šã®è¦‹å‡ºã—..."></div><div class="form-group"><label>å†…å®¹</label><textarea class="review-item-content" rows="4" placeholder="å…·ä½“çš„ãªå†…å®¹..."></textarea></div><button class="btn btn-secondary" style="background: #e74c3c; font-size: 0.8em; padding: 5px 10px;" onclick="this.parentElement.remove()">ã“ã®é …ç›®ã‚’å‰Šé™¤</button>`;
            container.appendChild(newItem);
        }

        // ãƒ¡ãƒ¼ã‚«ãƒ¼é¸æŠè‚¢ã‚’ç”Ÿæˆ
        function populateMakerOptions() {
            if (productMasterData.size === 0) return;
            const makers = new Set();
            productMasterData.forEach(prod => {
                if (prod.group) makers.add(prod.group);
            });

            document.querySelectorAll('select[id^="makerSelect_"]').forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">ãƒ¡ãƒ¼ã‚«ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
                Array.from(makers).sort().forEach(maker => {
                    select.add(new Option(maker, maker, false, maker === currentValue));
                });
            });
            if (makers.size > 0) showToast(`${makers.size}å€‹ã®ãƒ¡ãƒ¼ã‚«ãƒ¼/ãƒ–ãƒ©ãƒ³ãƒ‰ã‚’æ¤œå‡ºã—ã¾ã—ãŸ`);
        }
        
        // å•†å“å£²ä¸Šè¡¨ã®æ›´æ–°
        function updateProductTable(componentId) {
            const select = document.getElementById('makerSelect_' + componentId);
            const tableDiv = document.getElementById('table_' + componentId);
            const addProductDiv = document.getElementById('addProductArea_' + componentId);
            const selectedMaker = select?.value;

            if (!csvData.productSales) { tableDiv.innerHTML = `<p class="message error">å•†å“åˆ¥å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„</p>`; addProductDiv.style.display = 'none'; return; }
            if (productMasterData.size === 0) { tableDiv.innerHTML = `<p class="message error">å•†å“ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„</p>`; addProductDiv.style.display = 'none'; return; }
            if (!selectedMaker) { tableDiv.innerHTML = `<div style="padding: 20px; text-align: center; color: #666; border: 2px dashed #ddd; border-radius: 8px;"><h4>â—† å•†å“åˆ¥å£²ä¸Šè¡¨</h4><p>ä¸Šã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‹ã‚‰ãƒ¡ãƒ¼ã‚«ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„</p></div>`; addProductDiv.style.display = 'none'; return; }
            
            try {
                const data = csvData.productSales;
                const headers = data[0];
                const idx = { code: headers.indexOf('å•†å“ã‚³ãƒ¼ãƒ‰'), name: headers.indexOf('å•†å“å'), maker: headers.indexOf('ã‚°ãƒ«ãƒ¼ãƒ—ã‚³ãƒ¼ãƒ‰'), dept: headers.indexOf('éƒ¨é–€å'), sales: headers.indexOf('ç´”å£²ä¸Š'), netSales: headers.indexOf('ç´”å£²ä¸Š(ç¨æŠœ)'), ratio: headers.indexOf('ç´”å£²ä¸Šæ§‹æˆæ¯”'), qty: headers.indexOf('è²©å£²ç‚¹æ•°') };
                if ([idx.code, idx.maker, idx.qty, idx.netSales].includes(-1)) { throw new Error('å•†å“åˆ¥å£²ä¸ŠCSVã®åˆ—åï¼ˆå•†å“ã‚³ãƒ¼ãƒ‰, ã‚°ãƒ«ãƒ¼ãƒ—ã‚³ãƒ¼ãƒ‰, è²©å£²ç‚¹æ•°, ç´”å£²ä¸Š(ç¨æŠœ)ï¼‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚'); }

                const filteredRows = data.slice(1).filter(row => row[idx.maker]?.trim() === selectedMaker && (parseInt(row[idx.qty], 10) || 0) > 0);
                
                const displayHeaders = ['å•†å“å', 'ã‚°ãƒ«ãƒ¼ãƒ—ã‚³ãƒ¼ãƒ‰', 'éƒ¨é–€å', 'ç´”å£²ä¸Š', 'ç´”å£²ä¸Š(ç¨æŠœ)', 'ç´”å£²ä¸Šæ§‹æˆæ¯”', 'è²©å£²ç‚¹æ•°'];
                let tableHTML = '<table class="data-table"><thead><tr>';
                displayHeaders.forEach(h => { tableHTML += `<th>${h}</th>`; });
                tableHTML += `<th>å•†å“ã‚’å‰Šé™¤</th></tr></thead><tbody>`;
                
                filteredRows.forEach((row) => {
                    tableHTML += createTableRow(row[idx.code], row, idx, componentId);
                });
                
                tableHTML += `<tr class="totals-row" style="background:#efefef;font-weight:bold;"><td colspan="3">ã€åˆè¨ˆã€‘</td><td data-total="sales"></td><td data-total="netSales"></td><td>-</td><td data-total="qty"></td><td></td></tr>`;
                tableHTML += '</tbody></table>';
                tableDiv.innerHTML = tableHTML;

                addProductDiv.style.display = 'block';
                populateAddProductDropdown(componentId, selectedMaker);
                recalculateAllSalesData(componentId);

            } catch (e) { tableDiv.innerHTML = `<p class="message error">ã‚¨ãƒ©ãƒ¼: ${e.message}</p>`; showToast(e.message, 'error'); }
        }

        // å•†å“è¿½åŠ ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’ç”Ÿæˆ
        function populateAddProductDropdown(componentId, selectedMaker) {
            const select = document.getElementById(`addProductSelect_${componentId}`);
            select.innerHTML = '<option value="">è¿½åŠ ã™ã‚‹å•†å“ã‚’é¸æŠ...</option>';
            for (const [code, product] of productMasterData.entries()) {
                if (product.group === selectedMaker) {
                    select.add(new Option(product.name, code));
                }
            }
        }
        
        // å•†å“ãƒã‚¹ã‚¿ã‹ã‚‰å•†å“ã‚’è¡¨ã«è¿½åŠ 
        function addProductFromMaster(componentId) {
            const select = document.getElementById(`addProductSelect_${componentId}`);
            const productCode = select.value;
            if (!productCode) return;

            const table = document.getElementById(`table_${componentId}`).querySelector('tbody');
            // æ—¢ã«è¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if (table.querySelector(`tr[data-product-code="${productCode}"]`)) {
                showToast('ã“ã®å•†å“ã¯æ—¢ã«è¿½åŠ ã•ã‚Œã¦ã„ã¾ã™ã€‚æ•°é‡ã‚’ç·¨é›†ã—ã¦ãã ã•ã„ã€‚', 'error');
                return;
            }

            const product = productMasterData.get(productCode);
            const netSales = product.price * 1;
            const sales = Math.floor(netSales * 1.1); // ä»®ç¨ç‡10%

            const headers = csvData.productSales[0];
            const idx = { code: headers.indexOf('å•†å“ã‚³ãƒ¼ãƒ‰'), name: headers.indexOf('å•†å“å'), maker: headers.indexOf('ã‚°ãƒ«ãƒ¼ãƒ—ã‚³ãƒ¼ãƒ‰'), dept: headers.indexOf('éƒ¨é–€å'), sales: headers.indexOf('ç´”å£²ä¸Š'), netSales: headers.indexOf('ç´”å£²ä¸Š(ç¨æŠœ)'), ratio: headers.indexOf('ç´”å£²ä¸Šæ§‹æˆæ¯”'), qty: headers.indexOf('è²©å£²ç‚¹æ•°') };

            const mockRow = [];
            mockRow[idx.code] = productCode;
            mockRow[idx.name] = product.name;
            mockRow[idx.maker] = product.group;
            mockRow[idx.dept] = product.dept;
            mockRow[idx.sales] = sales;
            mockRow[idx.netSales] = netSales;
            mockRow[idx.qty] = 1;


            const newRowHTML = createTableRow(productCode, mockRow, idx, componentId);
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = newRowHTML;
            table.insertBefore(tempDiv.firstChild, table.querySelector('.totals-row'));
            
            recalculateAllSalesData(componentId);
            select.value = ''; // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
        }

        // å…±é€šã®ãƒ†ãƒ¼ãƒ–ãƒ«è¡Œç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯
        function createTableRow(productCode, rowData, idx, componentId) {
            let rowHTML = `<tr data-product-code="${productCode}">`;
            rowHTML += `<td>${rowData[idx.name] || ''}</td>`;
            rowHTML += `<td>${rowData[idx.maker] || ''}</td>`;
            rowHTML += `<td>${rowData[idx.dept] || ''}</td>`;
            rowHTML += `<td><input type="text" class="editable-cell" value="${rowData[idx.sales] || ''}" readonly></td>`;
            rowHTML += `<td><input type="text" class="editable-cell" value="${rowData[idx.netSales] || ''}" readonly></td>`;
            rowHTML += `<td data-role="ratio">${rowData[idx.ratio] || '0.00'}</td>`;
            rowHTML += `<td><input type="text" class="editable-cell" value="${rowData[idx.qty] || ''}" onchange="handleQtyChange(this, ${componentId})"></td>`;
            rowHTML += `<td><button class="delete-row-btn" title="ã“ã®è¡Œã‚’å‰Šé™¤" onclick="this.closest('tr').remove(); recalculateAllSalesData(${componentId})">ğŸ—‘ï¸</button></td>`;
            rowHTML += '</tr>';
            return rowHTML;
        }


        // è²©å£²ç‚¹æ•°ã®å¤‰æ›´ã‚’å‡¦ç†ã™ã‚‹é–¢æ•°
        function handleQtyChange(qtyInput, componentId) {
            const row = qtyInput.closest('tr');
            const productCode = row.dataset.productCode;
            const newQty = parseInt(qtyInput.value, 10);

            if (isNaN(newQty) || newQty <= 0) {
                row.remove();
            } else {
                const unitPrice = productMasterData.get(productCode)?.price;
                if (typeof unitPrice !== 'number') {
                    showToast(`ã‚¨ãƒ©ãƒ¼: å•†å“ã‚³ãƒ¼ãƒ‰ã€Œ${productCode}ã€ã®å˜ä¾¡ãŒãƒã‚¹ã‚¿ã«ã‚ã‚Šã¾ã›ã‚“ã€‚å£²ä¸Šã¯æ›´æ–°ã•ã‚Œã¾ã›ã‚“ã€‚`, 'error');
                } else {
                    const salesCell = row.cells[3].querySelector('input');
                    const netSalesCell = row.cells[4].querySelector('input');
                    const newNetSales = unitPrice * newQty;
                    const newSales = Math.floor(newNetSales * 1.1); // ä»®ç¨ç‡10%
                    
                    salesCell.value = newSales;
                    netSalesCell.value = newNetSales;
                }
            }
            recalculateAllSalesData(componentId);
        }

        // å£²ä¸Šé–¢é€£ã®å†è¨ˆç®—ã‚’ã™ã¹ã¦è¡Œã†é–¢æ•°
        function recalculateAllSalesData(componentId) {
            const table = document.getElementById('table_' + componentId)?.querySelector('.data-table');
            if (!table) return;

            let grandTotalSales = 0;
            let grandTotalNetSales = 0;
            let grandTotalQty = 0;
            
            const rows = table.querySelectorAll('tbody tr:not(.totals-row)');
            
            rows.forEach(row => {
                grandTotalNetSales += parseFloat(row.cells[4].querySelector('input').value) || 0;
            });

            rows.forEach(row => {
                const netSales = parseFloat(row.cells[4].querySelector('input').value) || 0;
                const ratioCell = row.cells[5];
                const ratio = (grandTotalNetSales > 0) ? ((netSales / grandTotalNetSales) * 100).toFixed(2) : "0.00";
                ratioCell.textContent = ratio;

                grandTotalQty += parseInt(row.cells[6].querySelector('input').value, 10) || 0;
                grandTotalSales += parseFloat(row.cells[3].querySelector('input').value) || 0;
            });
            
            const totalsRow = table.querySelector('.totals-row');
            if (totalsRow) {
                totalsRow.querySelector('[data-total="sales"]').textContent = `Â¥${grandTotalSales.toLocaleString()}`;
                totalsRow.querySelector('[data-total="netSales"]').textContent = `Â¥${grandTotalNetSales.toLocaleString()}`;
                totalsRow.querySelector('[data-total="qty"]').textContent = `${grandTotalQty.toLocaleString()}ç‚¹`;
            }
        }
        
        function generateChart(chartType) {
            const data = csvData[chartType];
            if (!data || data.length < 2) return `<div><p>ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p></div>`;
            
            const headers = data[0];
            const findIndex = (possibleNames) => {
                for (const name of possibleNames) {
                    const index = headers.indexOf(name);
                    if (index !== -1) return index;
                }
                return -1;
            };
            const labelIndex = findIndex(['å®¢å±¤å', 'åˆ†é¡']);
            const valueIndex = findIndex(['å®¢æ•°']);

            if (labelIndex === -1 || valueIndex === -1) {
                return `<div><p>CSVã«ã€Œå®¢å±¤åã€ã¾ãŸã¯ã€Œå®¢æ•°ã€ã®åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p></div>`;
            }

            const items = [];
            let total = 0;
            data.slice(1).forEach(row => {
                const label = row[labelIndex]?.trim();
                const value = parseInt(row[valueIndex]?.replace(/,/g, ''), 10) || 0;
                if (label && value > 0) {
                    items.push({ label, value });
                    total += value;
                }
            });

            if (items.length === 0) return `<div><p>æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div>`;
            
            const colors = ['#dc3912', '#ff9900', '#109618', '#990099', '#0099c6', '#dd4477', '#66aa00', '#b82e2e'];
            let chartHtml = `<div style="display: flex; align-items: center; justify-content: center; gap: 20px; margin-top: 20px;">`;
            let svgPaths = '';
            let currentAngle = -90;
            items.forEach((item, i) => {
                const angle = (item.value / total) * 360;
                const x1 = 150 + 120 * Math.cos(currentAngle * Math.PI / 180), y1 = 150 + 120 * Math.sin(currentAngle * Math.PI / 180);
                currentAngle += angle;
                const x2 = 150 + 120 * Math.cos(currentAngle * Math.PI / 180), y2 = 150 + 120 * Math.sin(currentAngle * Math.PI / 180);
                svgPaths += `<path d="M 150 150 L ${x1} ${y1} A 120 120 0 ${angle > 180 ? 1 : 0} 1 ${x2} ${y2} Z" fill="${colors[i % colors.length]}"></path>`;
            });
            chartHtml += `<div style="flex-shrink: 0;"><svg width="300" height="300" viewBox="0 0 300 300">${svgPaths}</svg></div>`;
            let legendHtml = '<div style="flex: 1; text-align: left;">';
            items.forEach((item, i) => {
                legendHtml += `<div style="display: flex; align-items: center; margin-bottom: 8px;">
                               <div style="width: 16px; height: 16px; background-color: ${colors[i % colors.length]}; margin-right: 8px; border-radius: 2px;"></div>
                               <input type="text" value="${item.label}" style="border: none; padding: 2px 6px; margin-right: 8px; font-size: 14px; background: white; width: 120px;">
                               <span style="font-size: 14px; color: #2c3e50; font-weight: bold;">${item.value}äºº (${((item.value / total) * 100).toFixed(1)}%)</span></div>`;
            });
            chartHtml += legendHtml + '</div></div>';
            return chartHtml;
        }

        function updateChart(componentId) {
            const chartType = document.getElementById(`chartType_${componentId}`).value;
            document.getElementById('chart_' + componentId).innerHTML = generateChart(chartType);
        }
        function createImageUploadInputs(id, count) { let h = ''; for (let i = 1; i <= count; i++) { h += `<div class="form-group" style="border-top: 1px solid #eee; padding-top: 15px; margin-top: 15px;"><label>ç”»åƒãƒ•ã‚¡ã‚¤ãƒ« ${i}</label><input type="file" accept="image/*" id="imageFile${i}_${id}" onchange="handleMultiImageUpload(${id}, ${i})"><label style="margin-top:10px;">ç”»åƒ ${i} ã®èª¬æ˜æ–‡</label><textarea rows="2" id="imageCaption${i}_${id}" placeholder="ã“ã®ç”»åƒã®èª¬æ˜..." oninput="updateImageDisplay(${id})"></textarea></div>`; } return h; }
        function updateImageLayout(id) { const l = document.getElementById('imageLayout_' + id).value; document.getElementById('imageUploadArea_' + id).innerHTML = createImageUploadInputs(id, l === 'single' ? 1 : l === 'two' ? 2 : 3); updateImageDisplay(id); }
        function handleMultiImageUpload(id, idx) { const f = document.getElementById(`imageFile${idx}_${id}`); if (!f.files[0]) return; const r = new FileReader(); r.onload = e => { if (!window.imageData[id]) window.imageData[id] = {}; window.imageData[id][idx] = e.target.result; updateImageDisplay(id); }; r.readAsDataURL(f.files[0]); }
        function updateImageDisplay(id) { const p = document.getElementById('imagePreview_' + id); const d = window.imageData[id] || {}; if (Object.keys(d).length === 0) { p.innerHTML = '<p>ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„</p>'; return; } let h = '<div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">'; Object.keys(d).sort().forEach(idx => { const cap = document.getElementById(`imageCaption${idx}_${id}`)?.value.replace(/\n/g, '<br>') || ''; h += `<div style="flex: 1; min-width: 200px; max-width: 300px; text-align: center;"><img src="${d[idx]}" style="width: 100%; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);"><p style="font-size: 0.9em; color: #666; margin-top: 8px; text-align: left;">${cap}</p></div>`; }); p.innerHTML = h + '</div>'; }
        function updateTextLayout(id) { document.getElementById(`textImageOptions_${id}`).style.display = document.getElementById(`textLayout_${id}`).value === 'text-only' ? 'none' : 'block'; updateTextBlockDisplay(id); }
        function handleTextBlockImageUpload(id) { const f = document.getElementById(`textImageFile_${id}`); if (!f.files[0]) return; const r = new FileReader(); r.onload = e => { window.textImageData[id] = e.target.result; updateTextBlockDisplay(id); }; r.readAsDataURL(f.files[0]); }
        function updateTextBlockDisplay(id) { const p = document.getElementById(`textPreview_${id}`); const l = document.getElementById(`textLayout_${id}`).value; const c = document.getElementById(`content_${id}`).value.replace(/\n/g, '<br>'); if (l === 'text-only') { p.innerHTML = c; return; } const iS = document.getElementById(`textImageSize_${id}`).value; const iD = window.textImageData[id]; let iH = iD ? `<div class="image-part" style="flex-basis: ${iS}; flex-shrink: 0;"><img src="${iD}" style="width: 100%; border-radius: 8px;"></div>` : `<div class="image-part" style="flex-basis: ${iS}; flex-shrink: 0; border: 2px dashed #ccc; display:flex; align-items:center; justify-content:center; min-height:100px; color:#999;">ç”»åƒ</div>`; const tH = `<div class="text-part" style="flex: 1;">${c}</div>`; p.innerHTML = `<div style="display: flex; gap: 20px; align-items: flex-start; flex-direction: ${l === 'text-image-right' ? 'row' : 'row-reverse'};">${l === 'text-image-right' ? tH + iH : iH + tH}</div>`; }
        function loadSalesData(id) {
            const data = csvData.transaction;
            if (!data || data.length < 2) { showToast('å–å¼•ãƒ‡ãƒ¼ã‚¿ãŒæœªå…¥åŠ›ã§ã™', 'error'); return; }
            try {
                const headers = data[0];
                const salesIndex = headers.indexOf('ç´”å£²ä¸Š(ç¨æŠœ)');
                const customerIndex = headers.indexOf('å–å¼•ID');

                if (salesIndex === -1 || customerIndex === -1) {
                    throw new Error('å–å¼•ãƒ‡ãƒ¼ã‚¿CSVã«ã€Œå–å¼•IDã€ã¾ãŸã¯ã€Œç´”å£²ä¸Š(ç¨æŠœ)ã€åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
                }

                const salesData = data.slice(1);
                const totalSales = salesData.reduce((sum, row) => sum + (parseFloat(row[salesIndex]) || 0), 0);
                const customerSet = new Set(salesData.map(row => row[customerIndex]).filter(Boolean));
                const customerCount = customerSet.size;
                const avgPrice = customerCount > 0 ? Math.floor(totalSales / customerCount) : 0;
                
                document.getElementById(`sales_${id}`).value = `Â¥${totalSales.toLocaleString()}`;
                document.getElementById(`customers_${id}`).value = `${customerCount}äºº`;
                document.getElementById(`avgprice_${id}`).value = `Â¥${avgPrice.toLocaleString()}`;
                showToast('å£²ä¸Šæƒ…å ±ã‚’è¨ˆç®—ã—ã¾ã—ãŸ');
            } catch (e) {
                showToast(`è¨ˆç®—ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error');
            }
        }
        function moveUp(btn) { const c = btn.closest('.report-component'); if (c.previousElementSibling) c.parentNode.insertBefore(c, c.previousElementSibling); }
        function moveDown(btn) { const c = btn.closest('.report-component'); if (c.nextElementSibling) c.parentNode.insertBefore(c.nextElementSibling, c); }
        function deleteComponent(btn) { const c = btn.closest('.report-component'); if (confirm(`ã€Œ${c.querySelector('h4').textContent}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) { c.remove(); if (document.getElementById('dropZone').children.length === 0) { document.getElementById('dropZone').innerHTML = `<div class="drop-zone-placeholder"><i>ğŸ“¦</i><h3>ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’...</h3></div>`; } } }
        function clearCanvas() { if (confirm('ã™ã¹ã¦ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { document.getElementById('dropZone').innerHTML = `<div class="drop-zone-placeholder"><i>ğŸ“¦</i><h3>ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’...</h3></div>`; showToast('ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ'); } }
        function previewReport() { if (document.querySelectorAll('.report-component').length === 0) { showToast('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡ãŒã‚ã‚Šã¾ã›ã‚“', 'error'); return; } const win = window.open('', '_blank'); win.document.write(generatePrintPreviewContent()); win.document.close(); }
        function printReport() { if (document.querySelectorAll('.report-component').length === 0) { showToast('å°åˆ·å¯¾è±¡ãŒã‚ã‚Šã¾ã›ã‚“', 'error'); return; } const win = window.open('', '_blank'); win.document.write(generatePrintPreviewContent()); win.document.close(); setTimeout(() => { win.print(); win.close(); }, 500); }
        function generatePrintPreviewContent() {
            let content = `<!DOCTYPE html><html lang="ja"><head><title>ãƒ¬ãƒãƒ¼ãƒˆ</title>
            <link rel="preconnect" href="https://fonts.googleapis.com">
            <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
            <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">
            <style>
                body { font-family: 'Noto Serif JP', serif; line-height: 1.7; background: white; color: #333; counter-reset: section-counter; }
                @page { size: A4 landscape; margin: 15mm; }
                * { -webkit-print-color-adjust: exact !important; color-adjust: exact !important; }
                .report-container { width: 100%; margin: 0 auto; }
                h1 { font-size: 24pt; text-align: center; color: #333; margin: 0; font-weight: 700;}
                h2 { font-family: 'Hiragino Sans', sans-serif; font-size: 16pt; font-weight: bold; color: #333; background-color: #efefef; padding: 8px; margin-top: 25px; margin-bottom: 20px; page-break-after: avoid; display: flex; align-items: center; }
                h2::before { counter-increment: section-counter; content: "0" counter(section-counter); background-color: #dc3912; color: white; padding: 8px 12px; margin-right: 15px; font-size: 1.2em; font-weight: bold; }
                h3 { font-size: 13pt; color: #333; border-bottom: 2px solid #efefef; padding-bottom: 5px; margin-top: 20px; margin-bottom: 10px; page-break-after: avoid; font-weight: 700; }
                p { margin-bottom: 15px; font-size: 11pt; }
                .section { margin-bottom: 20px; page-break-inside: avoid; }
                .report-header { text-align: center; margin-bottom: 40px; page-break-after: avoid; }
                .report-header p { font-size: 12pt; margin: 5px 0; }
                .report-header .period { font-size: 11pt; color: #666; }
                .sales-summary-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 12pt; }
                .sales-summary-table td { border: 1px solid #ddd; padding: 12px; text-align: center; width: 33.33%; background-color: #fafafa; }
                .sales-summary-table td strong { color: #333; display: block; margin-bottom: 5px; font-size: 11pt; font-weight: bold; }
                .data-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 9pt; }
                .data-table th, .data-table td { padding: 8px 10px; border: 1px solid #ccc; text-align: left; vertical-align: middle; }
                .data-table th { background: #efefef; font-weight: bold; font-family: 'Hiragino Sans', sans-serif; }
                .data-table tr[style*="font-weight:bold"] { background-color: #efefef !important; font-weight: bold; font-size: 10pt; }
                .data-table .delete-row-btn { display: none; }
                .demographics-container { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; page-break-inside: avoid; }
                .chart-and-legend { display: flex; justify-content: center; align-items: center; gap: 30px; width: 100%; margin-bottom: 20px; }
                .chart-part { flex: 1; text-align: right; max-width: 400px; }
                .chart-part svg { width: 100%; height: auto; }
                .legend-part-wrapper { flex: 1; text-align: left; }
                .legend-part { column-count: 1; }
                .legend-item { display: flex; align-items: center; margin-bottom: 8px; font-size: 10pt; page-break-inside: avoid; }
                .legend-color { width: 16px; height: 16px; margin-right: 10px; border-radius: 3px; flex-shrink: 0; }
                .legend-label { margin-right: 10px; }
                .legend-value { font-weight: bold; }
                .analysis-comment-wrapper { margin: 0 auto; width: 80%; text-align: left; }
                .text-content, .comment-part, .event-review-body { white-space: pre-wrap; line-height: 1.8; font-size: 11pt; background: #ffffff; padding: 20px; border-radius: 5px; margin-top: 10px; border: 1px solid #efefef; text-align: left;}
                .image-section-wrapper { display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 80vh; text-align: center; }
                .image-section { margin-top: 20px; }
                .image-section .image-block { display: inline-block; margin: 10px; text-align: left; vertical-align: top; width: 30%; }
                .image-section img { max-width: 100%; height: auto; border: 1px solid #ddd; padding: 4px; margin-bottom: 5px; }
                .image-section p { font-size: 9pt; color: #555; text-align: center; }
                .text-block-content .text-image-container { display:flex; gap: 20px; align-items: flex-start; }
                .text-block-content .image-part { flex-shrink: 0; }
                .text-block-content .image-part img { width: 100%; height: auto; border-radius: 8px; }
                .text-block-content .text-part { flex: 1; }
            </style></head><body><div class="report-container">`;
            document.querySelectorAll('.report-component').forEach((component) => {
                const {type, id} = component.dataset;
                try {
                    switch (type) {
                        case 'header': content += `<div class="section"><div class="report-header"><h1>${document.getElementById(`event_${id}`).value}</h1><p>${document.getElementById(`company_${id}`).value} ${document.getElementById(`honorific_${id}`).value}</p><p class="period">${document.getElementById(`period_${id}`).value}</p></div></div>`; break;
                        case 'sales-summary': content += `<div class="section"><h2>å£²ä¸Šã‚µãƒãƒªãƒ¼ï¼ˆMDå…¨ä½“ã®å£²ä¸Šï¼‰</h2><table class="sales-summary-table"><tr><td><strong>ç´”å£²ä¸Š(ç¨æŠœ)</strong> ${document.getElementById(`sales_${id}`).value}</td><td><strong>è³¼å…¥å®¢æ•°</strong> ${document.getElementById(`customers_${id}`).value}</td><td><strong>å¹³å‡è³¼å…¥å˜ä¾¡</strong> ${document.getElementById(`avgprice_${id}`).value}</td></tr></table></div>`; break;
                        case 'event-review': content += `<div class="section page-break-before"><h2>MDå…¨ä½“ã®æŒ¯ã‚Šè¿”ã‚Š</h2>`; component.querySelectorAll('.review-item').forEach(item => { const title = item.querySelector('.review-item-title').value; const reviewContent = item.querySelector('.review-item-content').value.replace(/\n/g, '<br>'); if (title || reviewContent) { content += `<h3>${title}</h3><div class="event-review-body">${reviewContent}</div>`; } }); content += `</div>`; break;
                        case 'product-table': content += `<div class="section page-break-before"><h2>å•†å“åˆ¥å£²ä¸Šè¡¨</h2>`; const tableNode = component.querySelector('.data-table'); if (tableNode) { const clonedTable = tableNode.cloneNode(true); clonedTable.querySelectorAll('input.editable-cell').forEach(input => { const text = document.createTextNode(input.value); input.parentNode.replaceChild(text, input); }); clonedTable.querySelector('thead tr').lastChild.remove(); clonedTable.querySelectorAll('tbody tr').forEach(tr => { if(tr.lastChild) tr.lastChild.remove(); }); content += clonedTable.outerHTML; } content += `</div>`; break;
                        case 'demographics-chart': content += `<div class="section page-break-before"><h2>å®¢å±¤åˆ†æ (${document.querySelector(`#chartType_${id} option:checked`).textContent})</h2>`; const chartContainer = document.getElementById(`chart_${id}`); if (chartContainer) { let legendHtml = ''; chartContainer.querySelectorAll('div[style*="display: flex"] > div:last-child > div').forEach(item => { const color = item.querySelector('div[style*="background-color"]').style.backgroundColor; const label = item.querySelector('input[type="text"]').value; const value = item.querySelector('span').textContent; legendHtml += `<div class="legend-item"><div class="legend-color" style="background-color: ${color};"></div><span class="legend-label">${label}</span><span class="legend-value">${value}</span></div>`; }); const commentText = document.getElementById(`comment_${id}`).value; content += `<div class="demographics-container"><div class="chart-and-legend"><div class="chart-part">${chartContainer.querySelector('svg')?.outerHTML || ''}</div><div class="legend-part-wrapper"><div class="legend-part">${legendHtml}</div></div></div>`; if (commentText.trim() !== '') { content += `<div class="analysis-comment-wrapper"><h3>åˆ†æã‚³ãƒ¡ãƒ³ãƒˆ</h3><div class="comment-part">${commentText.replace(/\n/g, '<br>')}</div></div>`; } content += `</div>`; } content += `</div>`; break;
                        case 'image': content += `<div class="section image-section-wrapper page-break-before"><div><h2>${document.getElementById(`imageTitle_${id}`).value}</h2><div class="image-section">${document.getElementById(`imagePreview_${id}`).innerHTML.replace(/<div style="flex: 1[^>]+>/g, '<div class="image-block">')}</div></div></div></div>`; break;
                        case 'customer-voice': content += `<div class="section page-break-before"><h2>ãŠå®¢æ§˜ã®å£°</h2><div class="text-content">${document.getElementById(`voice_${id}`).value.replace(/\n/g, '<br>')}</div></div>`; break;
                        case 'staff-comments': content += `<div class="section page-break-before"><h2>ã‚¹ã‚¿ãƒƒãƒ•æ‰€æ„Ÿ</h2><div class="text-content">${document.getElementById(`staff_${id}`).value.replace(/\n/g, '<br>')}</div></div>`; break;
                        case 'text-block': const title = document.getElementById(`title_${id}`).value; const layout = document.getElementById(`textLayout_${id}`).value; const textContent = document.getElementById(`content_${id}`).value.replace(/\n/g, '<br>'); const imageSrc = window.textImageData[id]; content += `<div class="section page-break-before"><h2>${title}</h2>`; if (layout === 'text-only' || !imageSrc) { content += `<div class="text-block-content">${textContent}</div>`; } else { const imageSize = document.getElementById(`textImageSize_${id}`).value; const textPart = `<div class="text-part">${textContent}</div>`; const imagePart = `<div class="image-part" style="flex-basis: ${imageSize};"><img src="${imageSrc}"></div>`; content += `<div class="text-block-content"><div class="text-image-container">${layout === 'text-image-left' ? imagePart + textPart : textPart + imagePart}</div></div>`; } content += `</div>`; break;
                    }
                } catch (e) { content += `<p style="color:red;">ã‚¨ãƒ©ãƒ¼: ${e.message}</p>`; }
            });
            content += '</div></body></html>';
            return content;
        }
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            if (!toast) return;
            toast.textContent = message;
            toast.style.background = type === 'error' ? '#e74c3c' : '#27ae60';
            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 3000);
        }
        document.addEventListener('DOMContentLoaded', () => {
            initDragDrop();
            setupFileUploads();
            showToast('ğŸ“Š ãƒ¬ãƒãƒ¼ãƒˆãƒ“ãƒ«ãƒ€ãƒ¼ã¸ã‚ˆã†ã“ãï¼');
        });
    </script>
</body>
</html>
